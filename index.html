<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jass-Liga SchÃ¤llebur</title>
    <!-- Favicon Platzhalter -->
    <link id="app-favicon" rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    
    <!-- 1. STYLE & ICONS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jass-gold': '#908059',
                        'jass-dark': '#1a1a1a',
                        'swiss-red': '#D80018',
                        'amber-600': '#d97706',
                        'amber-200': '#fde68a',
                    },
                    fontFamily: {
                        'comic': ['Bangers', 'cursive'],
                        'sans': ['Roboto Condensed', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --swiss-red: #D80018;
            --paper-bg: #F3F0E6;
            --ink-black: #1a1a1a;
            --gold-base: #908059;
        }

        body { 
            background-color: var(--paper-bg);
            background-image: radial-gradient(#dcd9ce 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--ink-black);
            font-family: 'Roboto Condensed', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-comic { font-family: 'Bangers', cursive; letter-spacing: 1px; }

        /* UI COMPONENTS */
        .retro-card {
            background-color: #fff;
            border: 3px solid var(--ink-black);
            border-radius: 12px;
            box-shadow: 6px 6px 0px rgba(0,0,0,1);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .retro-card:active { transform: translate(2px, 2px); box-shadow: 4px 4px 0px rgba(0,0,0,1); }

        .retro-btn {
            background-color: var(--swiss-red);
            color: white;
            border: 3px solid var(--ink-black);
            border-radius: 8px;
            font-family: 'Bangers', cursive;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 4px 4px 0px rgba(0,0,0,1);
            transition: transform 0.1s;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .retro-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,1); }
        .retro-btn-secondary { background-color: var(--gold-base); color: var(--ink-black); }
        .retro-btn-outline { background-color: white; color: black; }
        .retro-btn-success { background-color: #16a34a; color: white; }
        
        .retro-input {
            background-color: #fff;
            border: 3px solid var(--ink-black);
            border-radius: 8px;
            font-family: 'Bangers', cursive;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
            outline: none;
        }
        .retro-input:focus { border-color: var(--swiss-red); }

        .header-pattern-container {
            position: absolute; inset: 0; z-index: 0;
            background-color: var(--gold-base);
            border-bottom: 4px solid var(--ink-black);
        }
        
        .header-pattern-img {
            position: absolute; inset: 0; z-index: 0;
            background-repeat: repeat;
            background-size: 60px 60px;
            opacity: 0.2;
            filter: brightness(10) grayscale(60%);
        }

        .avatar-card-frame {
            width: 70px; height: 100px; 
            border: 3px solid var(--ink-black); background: #000; 
            border-radius: 8px; overflow: hidden; position: relative;
            box-shadow: 2px 2px 0px rgba(0,0,0,1);
        }
        .avatar-img-pinned {
            width: 100%; height: 100%; object-fit: cover; object-position: bottom;
            transform: translateY(14%) scale(1.2); transform-origin: bottom center;
        }
        
        .tab-btn-active {
            background-color: var(--gold-base) !important;
            color: var(--ink-black) !important;
            transform: translateY(-4px);
            box-shadow: 2px 2px 0px #d80018 !important;
        }

        .modal-overlay { background-color: rgba(26, 26, 26, 0.95); backdrop-filter: blur(4px); }
        
        .stamp-definitiv {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            border: 4px solid #166534; color: #166534; padding: 5px 10px;
            font-family: 'Bangers', cursive; font-size: 2rem; text-transform: uppercase;
            opacity: 0.8; pointer-events: none; mix-blend-mode: multiply; z-index: 10;
        }

        .animate-in { animation: animateIn 0.3s ease-out forwards; }
        @keyframes animateIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #D80018; border: 2px solid black; cursor: pointer; margin-top: -10px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 3px; border: 1px solid #94a3b8; }
    </style>
</head>
<body class="pb-28 md:pb-0 min-h-screen flex flex-col">

    <div id="app"></div>
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, deleteDoc, doc, writeBatch, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- A. KONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAPkAhM-BhJfG5cljBk2S2KGN3TIg8IxXM",
        authDomain: "jassgenossenschaellebur.firebaseapp.com",
        projectId: "jassgenossenschaellebur",
        storageBucket: "jassgenossenschaellebur.firebasestorage.app",
        messagingSenderId: "409989986638",
        appId: "1:409989986638:web:b1f4cd88b0521c92dac61f",
        measurementId: "G-BBFM2BD01V"
        };

        const ADMIN_EMAILS = [
            "jerry.baettig@gmail.com",
            "jassgenossenschallebur@gmail.com"
        ];
        
        const CLUB_EMAIL = "jassgenossenschallebur@gmail.com";

        // --- EMAILJS KONFIGURATION ---
        const EMAIL_SERVICE_ID = "service_Jassgenossen2020";  
        const EMAIL_TEMPLATE_ID = "template_Jassgenossen202";
        const EMAIL_PUBLIC_KEY = "iDDsHBSu1RHSw8v8L";

        // --- B. ASSETS ---
        const LOGO_BASE64 = "https://raw.githubusercontent.com/jerrybaettig-boop/jassgenossen-schaellebur/6b6be0b76b1deaa9524af5f522e6addb15da85dc/img/jass%20file_gold1.png"; 
        const BG_BASE64 = "https://raw.githubusercontent.com/jerrybaettig-boop/jassgenossen-schaellebur/1749f1b1e5a0e6f2c98a0e2de1e9e2a54eb2aa0a/img/Sch%C3%A4lle.png";   
        
        const AVATARS = { 
            "Diego": "https://raw.githubusercontent.com/jerrybaettig-boop/jassgenossen-schaellebur/6b6be0b76b1deaa9524af5f522e6addb15da85dc/img/DT_Avatar_klein.png", 
            "Toni": "https://raw.githubusercontent.com/jerrybaettig-boop/jassgenossen-schaellebur/6b6be0b76b1deaa9524af5f522e6addb15da85dc/img/TS_Avatar_klein.png", 
            "Laurent": "https://raw.githubusercontent.com/jerrybaettig-boop/jassgenossen-schaellebur/6b6be0b76b1deaa9524af5f522e6addb15da85dc/img/LB_Avatar_klein.png", 
            "JÃ©rÃ´me": "https://raw.githubusercontent.com/jerrybaettig-boop/jassgenossen-schaellebur/6b6be0b76b1deaa9524af5f522e6addb15da85dc/img/JB_Avatar_klein.png" 
        };

        const LEGACY_DEBTS = [
            { name: "Toni", email: "toni.steinbeisser@gmail.com", amount: 207, roleKey: 'roleToni' },
            { name: "Laurent", email: "baettig.laurent@gmail.com", amount: 191, roleKey: 'roleLaurent' },
            { name: "JÃ©rÃ´me", email: "jerry.baettig@gmail.com", amount: 187, roleKey: 'roleJerome' },
            { name: "Diego", email: "tosoni.diego94@gmail.com", amount: 301, roleKey: 'roleDiego' }
        ];

        const SKILL_LABELS = ["skillJass", "skillWeis", "skillMatchCall", "skillMatchPlay", "skillColors", "skillCounting", "skillTrashTalk", "skillLevel"];
        const TRUMP_MODES = [
            { id: 'eichel', label: 'Eichel', mult: 1, icon: 'ðŸŒ°' },
            { id: 'rose', label: 'Rose', mult: 1, icon: 'ðŸŒ¹' },
            { id: 'schilte', label: 'Schilte', mult: 2, icon: 'ðŸ›¡ï¸' },
            { id: 'schelle', label: 'SchÃ¤lle', mult: 2, icon: 'ðŸ””' },
            { id: 'obenabe', label: 'Obenabe', mult: 3, icon: 'â¬‡ï¸' }, 
            { id: 'undeufe', label: 'Undeufe', mult: 3, icon: 'â¬†ï¸' }, 
        ];

        const URL_FALLBACK = "https://ui-avatars.com/api/?background=000&color=fff";
        const COLLECTIONS = { GAMES: 'jass_games', USERS: 'jass_users', EVENTS: 'jass_events', SETTINGS: 'jass_settings' };
        
        // --- C. STATE ---
        let app, auth, db, user;
        let userData = null; 
        let games = [], users = [], events = [], pendingUsers = [];
        let activeTab = 'leaderboard';
        let leaderboardFilter = 'season'; 
        let calculatorState = { team1: [], team2: [], rounds: [], penalties: [], activeStep: 'setup', selectedTrump: 'eichel' };
        let expandedHistoryDates = {}; 
        let selectedArchiveSeason = null;
        let currentLang = 'de';
        let currentSeasonId = '2025';
        let registrationRole = 'active';
        let editEventId = null; // FÃ¼r Admin Edit Mode

        // --- D. TEXTS & HELPERS ---
        const translations = {
            de: {
                subtitle: "Liga der Jass-Legenden",
                tabs: { leaderboard: "Statistik", events: "Events", calculator: "Match", members: "Member", admin: "Admin" },
                filters: { debt: "Schulden", season: "Aktuelle Saison", history: "Jass-Historie" },
                loginTitle: "Jass-Login", loginMemberBtn: "Login fÃ¼r Mitglieder", loginGuest: "Als Gast (Zuschauer)",
                registerTitle: "Mitgliedschaft beantragen", registerBtn: "Registrieren", guestBtn: "Ich bleibe als Gast",
                roleActive: "Aktivmitglied (CHF 30/Mt)", rolePatron: "GÃ¶nner (CHF 1000/Jr)",
                pendingTitle: "Anfrage gesendet", pendingText: "Deine Mitgliedschaft wird geprÃ¼ft.",
                nextEvents: "NÃ¤chste Events", pollEvents: "Termin-Abfrage", definitive: "BESTÃ„TIGT",
                noEntries: "Keine Daten.", createEvent: "Neuer Termin",
                join: "Dabei", decline: "Absagen", leave: "Abmelden",
                calcTitle: "Match Center", start: "Start", save: "Speichern", cancel: "Abbruch",
                penalties: "Strafen", points: "Punkte", weis: "Weis",
                paymentInfo: "MitgliederbeitrÃ¤ge & Spenden", matchRestricted: "Resultate erfassen nur fÃ¼r Aktivmitglieder.",
                guestHint: "Login fÃ¼r Vollzugriff",
                roleToni: "Der Eroberer", roleDiego: "Der Baron", roleLaurent: "Der Bube", roleJerome: "Der Charmeur", memberStandard: "Mitglied",
                host: "Host / Gastgeber", timeFrom: "Zeit Von", timeTo: "Zeit Bis", location: "Ort / Stadt",
                totalDebt: "Strafen Total (Alle Zeiten)", paidDebt: "Getilgt", openDebt: "Offen",
                profileTitle: "Spieler Profil", bioPlaceholder: "Ein echter Jassgenosse...",
                statsWins: "Siege", statsLosses: "Niederlagen", statsWeis: "Weis Total", statsDebt: "Schulden Akt.",
                skillJass: "Jassfertigkeit", skillWeis: "Weisen", skillMatchCall: "Match ansagen", skillMatchPlay: "Match durchfÃ¼hren",
                skillColors: "Farben angeben", skillCounting: "Karten zÃ¤hlen", skillTrashTalk: "JasssprÃ¼che", skillLevel: "SchÃ¤llebur-Level",
                editProfile: "Profil bearbeiten", updateProfile: "Profil Speichern"
            }
        };

        const t = (key) => translations['de'][key] || key;
        
        // NEU: Vorname Only Logic
        const getFirstName = (u) => {
            if (!u || !u.name) return 'Gast';
            return u.name.split(' ')[0];
        };

        const getAvatarUrl = (u) => {
            if (!u) return URL_FALLBACK;
            // Nutze Vornamen fÃ¼r Key Match
            const name = getFirstName(u);
            const key = Object.keys(AVATARS).find(k => name.includes(k));
            if (key) return AVATARS[key];
            if (u.avatar && u.avatar.length > 50) return u.avatar;
            if (u.photoURL) return u.photoURL;
            return URL_FALLBACK + `&name=${name}`;
        };
        
        const getTitle = (u) => u.roleKey ? t(u.roleKey) : (u.roleName || t('memberStandard'));
        const isMember = () => userData && (userData.role === 'active' || userData.role === 'patron' || userData.role === 'admin');
        const isActiveMember = () => userData && (userData.role === 'active' || userData.role === 'admin');
        const isAdmin = () => userData && userData.role === 'admin';

        const getLegacyDebt = (u) => {
            const match = LEGACY_DEBTS.find(l => (u.email && l.email && u.email.toLowerCase() === l.email.toLowerCase()) || (u.name && u.name.toLowerCase().includes(l.name.toLowerCase())));
            return match ? match.amount : 0;
        };

        const getAllPlayers = () => {
            let combined = [...users];
            LEGACY_DEBTS.forEach(legacy => {
                const exists = combined.find(u => (u.email && legacy.email && u.email.toLowerCase() === legacy.email.toLowerCase()) || (u.name && u.name.toLowerCase().includes(legacy.name.toLowerCase())));
                if (!exists) {
                    combined.push({ id: 'legacy-' + legacy.name, name: legacy.name, email: legacy.email, role: 'active', roleKey: legacy.roleKey, avatar: '', isVirtual: true, bio: t('bioPlaceholder') });
                } else {
                    const existingUser = combined.find(u => u.name.includes(legacy.name));
                    if(existingUser && !existingUser.roleKey) existingUser.roleKey = legacy.roleKey;
                }
            });
            return combined;
        };

        // --- KALENDER & EMAIL HELPERS ---
        const generateGoogleCalendarLink = (event) => {
            const d = event.date.toDate();
            const formatTime = (timeStr) => {
                const [h, m] = timeStr.split(':');
                const dCopy = new Date(d);
                dCopy.setHours(h, m, 0);
                return dCopy.toISOString().replace(/-|:|\.\d\d\d/g, "");
            }
            const startStr = formatTime(event.timeFrom);
            let endStr = "";
            if(event.timeTo) {
                const [hEnd, mEnd] = event.timeTo.split(':');
                const dEnd = new Date(d);
                dEnd.setHours(hEnd, mEnd, 0);
                endStr = dEnd.toISOString().replace(/-|:|\.\d\d\d/g, "");
            } else {
                const dEnd = new Date(d);
                dEnd.setHours(dEnd.getHours() + 3);
                endStr = dEnd.toISOString().replace(/-|:|\.\d\d\d/g, "");
            }
            const title = encodeURIComponent(`Jass SchÃ¤llebur: ${event.location || 'TBD'}`);
            const details = encodeURIComponent(`Jassrunde!\nHost: ${event.hostId ? 'Bekannt' : 'TBD'}\nLocation: ${event.location}`);
            const loc = encodeURIComponent(event.location || 'TBD');
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startStr}/${endStr}&details=${details}&location=${loc}`;
        };

        const downloadICS = (event) => {
            const d = event.date.toDate();
            const formatTime = (timeStr, dateObj) => {
                const [h, m] = timeStr.split(':');
                const newD = new Date(dateObj);
                newD.setHours(h, m, 0);
                return newD.toISOString().replace(/-|:|\.\d\d\d/g, "").split('T')[0] + 'T' + newD.toTimeString().split(' ')[0].replace(/:/g,'');
            };
            const startStr = formatTime(event.timeFrom, d);
            let endStr = event.timeTo ? formatTime(event.timeTo, d) : startStr;
            const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Jass SchÃ¤llebur//App//DE\nBEGIN:VEVENT\nUID:${event.id}@jass-schaellebur.web.app\nDTSTAMP:${new Date().toISOString().replace(/-|:|\.\d\d\d/g, "").split('T')[0]}T000000\nDTSTART:${startStr}\nDTEND:${endStr}\nSUMMARY:Jass SchÃ¤llebur\nDESCRIPTION:Jassrunde bei ${event.location || 'TBD'}\nLOCATION:${event.location || 'TBD'}\nEND:VEVENT\nEND:VCALENDAR`;
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jass_event_${event.date.toDate().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        const sendSystemEmail = async (recipientsArray, subject, message, link) => {
            if (typeof emailjs === 'undefined') {
                alert("EmailJS Skript fehlt! Fallback auf lokales Mail-Programm.");
                window.location.href = `mailto:?bcc=${recipientsArray.join(',')}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message + "\n\nLink: " + link)}`;
                return;
            }
            try {
                emailjs.init(EMAIL_PUBLIC_KEY);
                console.log("Versuche Email Senden an:", recipientsArray.length, "EmpfÃ¤nger");
                await emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, {
                    to_email: CLUB_EMAIL,          
                    bcc_emails: recipientsArray.join(','), 
                    subject: subject,
                    message: message,
                    event_link: link
                });
                alert(`âœ… Email wurde automatisch an alle ${recipientsArray.length} Mitglieder versendet!`);
            } catch (error) {
                console.error("EMAIL FEHLER:", error);
                alert("Fehler beim automatischen Versand. Ã–ffne Mail-Programm als Reserve.");
                window.location.href = `mailto:?bcc=${recipientsArray.join(',')}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message + "\n\nLink: " + link)}`;
            }
        };

        // --- E. RENDER FUNCTIONS ---

        const renderHeader = () => `
            <header class="relative text-white pt-10 pb-20 px-4 overflow-hidden border-b-4 border-black">
                <div class="header-pattern-container"><div class="header-pattern-img" style="background-image: url('${BG_BASE64}');"></div><div class="absolute inset-0 bg-gradient-to-b from-black/10 to-black/80"></div></div>
                <div class="max-w-4xl mx-auto text-center relative z-10">
                    <div class="w-64 h-64 mx-auto mb-2 relative group">
                        <div class="absolute inset-0 bg-yellow-100 rounded-full blur-xl opacity-0 group-hover:opacity-30 transition-opacity duration-500"></div>
                        <img src="${LOGO_BASE64}" onerror="this.style.display='none'" class="w-full h-full object-contain relative z-10 transform group-hover:scale-105 transition-all duration-500 drop-shadow-[0_8px_8px_rgba(0,0,0,0.6)]">
                    </div>
                    <div class="inline-block bg-black/80 backdrop-blur-sm border-2 border-yellow-500 px-4 py-2 rounded-lg transform -rotate-1 shadow-[4px_4px_0_rgba(0,0,0,0.5)] mb-2">
                        <h2 class="text-sm md:text-base font-bold tracking-widest uppercase font-mono text-yellow-400">${t('subtitle')}</h2>
                    </div>
                    ${userData && userData.role !== 'pending' ? `
                        <button onclick="signOutUser()" class="absolute top-4 right-4 flex flex-col items-center group z-50">
                            <div class="w-12 h-16 bg-white border-2 border-black rounded-lg overflow-hidden shadow-[2px_2px_0_rgba(0,0,0,1)] group-hover:translate-y-[-2px] transition-all relative">
                                <img src="${getAvatarUrl(userData)}" onerror="this.src='${URL_FALLBACK}'" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center transition"><i data-lucide="log-out" class="w-4 h-4 text-white"></i></div>
                            </div>
                            <div class="mt-1 bg-black text-white text-[9px] font-bold px-1.5 py-0.5 rounded border border-yellow-500 uppercase">${getFirstName(userData)}</div>
                        </button>
                    ` : `
                        <button onclick="openLoginModal()" class="absolute top-4 right-4 flex flex-col items-center group z-50">
                            <div class="w-12 h-16 border-2 border-black rounded-lg flex items-center justify-center shadow-[2px_2px_0_rgba(0,0,0,1)] group-hover:translate-y-[-2px] transition-all card-back-pattern" style="background-image: url('${BG_BASE64}');">
                                <div class="bg-black/50 p-1 rounded-full"><i data-lucide="key" class="w-4 h-4 text-white"></i></div>
                            </div>
                            <div class="mt-1 bg-black text-white text-[9px] font-bold px-1.5 py-0.5 rounded border border-slate-500 uppercase">${t('loginTitle')}</div>
                        </button>
                    `}
                </div>
            </header>
        `;

        const renderLoginModal = () => `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onclick="closeModal(event)">
                <div class="retro-card p-8 w-full max-w-sm text-center shadow-2xl bg-white relative">
                    <button onclick="closeModal(null, true)" class="absolute top-2 right-2 text-slate-400 hover:text-black"><i data-lucide="x"></i></button>
                    <h2 class="text-3xl font-comic text-slate-900 mb-6 uppercase transform -rotate-1">${t('loginTitle')}</h2>
                    <div class="space-y-4">
                        <button onclick="loginGoogle()" class="w-full py-3 retro-btn bg-white text-black hover:bg-slate-50 flex items-center justify-center gap-3 border-2 border-black shadow-[2px_2px_0_black]">
                             ${t('loginMemberBtn')}
                        </button>
                        <div class="h-px bg-slate-200 my-2"></div>
                        <div class="text-left bg-slate-50 p-3 rounded border border-slate-200">
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-2">${t('registerTitle')}</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <button onclick="setRegRole('active')" class="text-xs p-2 rounded border-2 ${registrationRole==='active'?'border-red-600 bg-red-50 text-red-700':'border-slate-300'} font-bold transition-all">Aktiv</button>
                                <button onclick="setRegRole('patron')" class="text-xs p-2 rounded border-2 ${registrationRole==='patron'?'border-red-600 bg-red-50 text-red-700':'border-slate-300'} font-bold transition-all">GÃ¶nner</button>
                            </div>
                            <button onclick="loginGoogle()" class="w-full py-2 retro-btn text-sm">${t('registerBtn')}</button>
                        </div>
                        <button onclick="loginGuestAndRedirect()" class="w-full py-2 text-xs font-bold text-slate-400 hover:text-black uppercase tracking-widest mt-2">${t('guestBtn')}</button>
                    </div>
                </div>
            </div>
        `;

        const renderEventDetailsModal = (eventId) => {
            const event = events.find(e => e.id === eventId);
            if (!event) return '';
            
            const allPlayers = getAllPlayers();
            const host = allPlayers.find(u => u.id === event.hostId)?.name || 'Unbekannt';
            
            const attendees = event.attendees || [];
            const declined = event.declined || [];
            const isConfirmed = event.status === 'confirmed';
            
            const activeUsers = allPlayers.filter(u => u.role === 'active' || u.role === 'admin');
            const pending = activeUsers.filter(u => !attendees.includes(u.id) && !declined.includes(u.id));

            const isJoined = userData && attendees.includes(userData.id);
            const isDeclined = userData && declined.includes(userData.id);
            const gCalLink = isConfirmed ? generateGoogleCalendarLink(event) : '#';

            // EDIT MODE?
            if (editEventId === eventId) {
                return `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="closeModal(event)">
                    <div class="retro-card p-6 w-full max-w-lg bg-white relative animate-in">
                        <h2 class="text-2xl font-comic mb-4">Event Bearbeiten</h2>
                        <div class="space-y-3">
                            <input type="date" id="edit-date" class="retro-input w-full px-3 py-2" value="${event.date.toDate().toISOString().split('T')[0]}">
                            <div class="flex gap-2">
                                <input type="time" id="edit-time-from" class="retro-input w-full px-3 py-2" value="${event.timeFrom}">
                                <input type="time" id="edit-time-to" class="retro-input w-full px-3 py-2" value="${event.timeTo}">
                            </div>
                            <input type="text" id="edit-loc" class="retro-input w-full px-3 py-2" value="${event.location}">
                            <div class="flex gap-2 mt-4">
                                <button onclick="updateEventData('${eventId}')" class="flex-1 retro-btn py-2">Speichern & Email</button>
                                <button onclick="editEventId=null; openEventDetails('${eventId}')" class="flex-1 bg-slate-200 text-slate-500 rounded font-bold uppercase">Abbruch</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            const renderUserRow = (uid) => {
                const u = allPlayers.find(p => p.id === uid);
                if (!u) return '';
                return `
                <div class="flex items-center justify-between mb-2 p-2 bg-slate-50 rounded border border-slate-100">
                    <div class="flex items-center gap-3">
                        <img src="${getAvatarUrl(u)}" class="w-8 h-8 rounded-full border border-black object-cover">
                        <span class="font-bold text-sm text-slate-700">${getFirstName(u)}</span>
                    </div>
                    ${isAdmin() ? `<button onclick="forceRemoveUserFromEvent('${eventId}', '${uid}')" class="text-slate-300 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}
                </div>`;
            };

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="closeModal(event)">
                <div class="retro-card p-6 w-full max-w-lg bg-white relative max-h-[90vh] overflow-y-auto animate-in">
                    <button onclick="closeModal(null, true)" class="absolute top-4 right-4 z-20 bg-slate-100 p-2 rounded-full hover:bg-red-100 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
                    
                    ${isConfirmed ? `<div class="absolute top-0 left-0 w-full bg-green-500 text-white text-center text-xs font-bold uppercase py-1 tracking-widest">Definitiv - Findet Statt</div>` : ''}

                    <div class="flex justify-between items-start mt-4 mb-1">
                        <h2 class="text-3xl font-comic text-slate-900">${event.date.toDate().toLocaleDateString('de-CH', {weekday:'long', day:'numeric', month:'long'})}</h2>
                        ${isAdmin() ? `<button onclick="enableEditMode('${eventId}')" class="bg-slate-100 p-2 rounded hover:bg-yellow-100"><i data-lucide="pencil" class="w-4 h-4 text-slate-500"></i></button>` : ''}
                    </div>
                    
                    <div class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-6 border-b-2 border-slate-200 pb-2">
                        ${event.timeFrom} Uhr @ ${event.location || 'TBD'} (Host: ${getFirstName({name:host})})
                    </div>
                    
                    ${isConfirmed ? `
                    <div class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg">
                        <h4 class="font-bold text-green-800 text-sm uppercase mb-2">ðŸ“… Kalender Eintrag</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <a href="${gCalLink}" target="_blank" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-green-300 rounded hover:bg-green-100 text-xs font-bold text-green-800 transition">
                                <i data-lucide="calendar" class="w-4 h-4"></i> Google
                            </a>
                            <button onclick="downloadICSForEvent('${event.id}')" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-green-300 rounded hover:bg-green-100 text-xs font-bold text-green-800 transition">
                                <i data-lucide="download" class="w-4 h-4"></i> Outlook / Apple
                            </button>
                        </div>
                    </div>
                    ` : ''}

                    <!-- ACTIONS FOR USER -->
                    ${userData && isActiveMember() ? `
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="updateEventStatus('${eventId}', 'join')" 
                            class="py-3 rounded-lg border-2 border-black font-bold uppercase shadow-[3px_3px_0_black] transition-transform active:translate-y-1 active:shadow-none flex items-center justify-center gap-2
                            ${isJoined ? 'bg-green-500 text-white' : 'bg-white hover:bg-green-50 text-green-700'}">
                            <i data-lucide="check" class="w-5 h-5"></i> ${t('join')}
                        </button>
                        <button onclick="updateEventStatus('${eventId}', 'decline')" 
                            class="py-3 rounded-lg border-2 border-black font-bold uppercase shadow-[3px_3px_0_black] transition-transform active:translate-y-1 active:shadow-none flex items-center justify-center gap-2
                            ${isDeclined ? 'bg-red-500 text-white' : 'bg-white hover:bg-red-50 text-red-700'}">
                            <i data-lucide="x" class="w-5 h-5"></i> ${t('decline')}
                        </button>
                    </div>
                    ` : ''}

                    <!-- TABS / LISTS -->
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-bold text-xs uppercase text-green-600 mb-2 flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> Dabei (${attendees.length})</h4>
                            <div class="pl-4 border-l-2 border-green-200">
                                ${attendees.length > 0 ? attendees.map(uid => renderUserRow(uid)).join('') : '<div class="text-slate-400 text-xs italic">Noch niemand</div>'}
                            </div>
                        </div>
                        
                        ${declined.length > 0 ? `
                        <div>
                            <h4 class="font-bold text-xs uppercase text-red-600 mb-2 flex items-center gap-2"><div class="w-2 h-2 bg-red-500 rounded-full"></div> Abgesagt (${declined.length})</h4>
                            <div class="pl-4 border-l-2 border-red-200 opacity-70">
                                ${declined.map(uid => renderUserRow(uid)).join('')}
                            </div>
                        </div>` : ''}

                        <div>
                            <h4 class="font-bold text-xs uppercase text-slate-400 mb-2 flex items-center gap-2"><div class="w-2 h-2 bg-slate-300 rounded-full"></div> Ausstehend (${pending.length})</h4>
                            <div class="pl-4 border-l-2 border-slate-200 opacity-60">
                                ${pending.length > 0 ? `<div class="text-xs text-slate-500">${pending.map(u => getFirstName(u)).join(', ')}</div>` : '<div class="text-slate-400 text-xs italic">Alle haben geantwortet!</div>'}
                            </div>
                        </div>
                    </div>

                    ${isAdmin() ? `
                        <div class="mt-8 pt-4 border-t border-slate-200">
                            <button onclick="handleDeleteEvent('${event.id}')" class="text-red-500 text-xs font-bold hover:underline">Event komplett lÃ¶schen</button>
                        </div>
                    ` : ''}
                </div>
            </div>`;
        };
        
        const renderCreateEventModal = () => {
            const allPlayers = getAllPlayers().filter(u => u.role !== 'pending');
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="closeModal(event)">
                <div class="retro-card p-6 w-full max-w-md bg-white relative">
                    <button onclick="closeModal(null, true)" class="absolute top-2 right-2 text-slate-400 hover:text-black"><i data-lucide="x"></i></button>
                    <h2 class="text-2xl font-comic text-slate-900 mb-4">${t('createEvent')}</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Datum</label>
                            <input type="date" id="new-event-date" class="retro-input w-full px-3 py-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold uppercase text-slate-500 block mb-1">${t('timeFrom')}</label>
                                <input type="time" id="new-event-time-from" class="retro-input w-full px-3 py-2" value="19:00">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-slate-500 block mb-1">${t('timeTo')}</label>
                                <input type="time" id="new-event-time-to" class="retro-input w-full px-3 py-2" value="23:00">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1">${t('location')}</label>
                            <input type="text" id="new-event-loc" class="retro-input w-full px-3 py-2" placeholder="z.B. Restaurant Adler">
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1">${t('host')}</label>
                            <select id="new-event-host" class="retro-input w-full px-3 py-2 bg-white">
                                ${allPlayers.map(p => `<option value="${p.id}" ${p.id === user.uid ? 'selected' : ''}>${getFirstName(p)}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="pt-2">
                            <button onclick="submitNewEvent()" class="w-full retro-btn py-3">${t('save')}</button>
                            <div class="text-[10px] text-slate-400 mt-2 text-center">Ã–ffnet Email-App zur Benachrichtigung aller Member</div>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        const renderRegistration = () => `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur">
                <div class="retro-card p-8 w-full max-w-sm shadow-2xl relative">
                    <h2 class="text-3xl font-comic text-slate-900 mb-4 text-center">${t('registerTitle')}</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500">Name</label>
                            <input type="text" id="reg-name" class="retro-input w-full px-4 py-2 text-lg" placeholder="Name" value="${auth.currentUser?.displayName || ''}">
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500">Membership</label>
                            <div class="grid grid-cols-1 gap-2 mt-1">
                                <label class="retro-card p-3 flex items-center gap-3 cursor-pointer hover:bg-yellow-50">
                                    <input type="radio" name="reg-role" value="active" checked class="w-4 h-4 accent-red-600"> <span class="font-bold text-sm">${t('roleActive')}</span>
                                </label>
                                <label class="retro-card p-3 flex items-center gap-3 cursor-pointer hover:bg-yellow-50">
                                    <input type="radio" name="reg-role" value="patron" class="w-4 h-4 accent-red-600"> <span class="font-bold text-sm">${t('rolePatron')}</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="completeRegistration()" class="w-full retro-btn text-lg py-3 mt-4">${t('save')}</button>
                        <button onclick="signOutUser()" class="w-full text-xs text-slate-400 hover:text-red-500 mt-2">Abbrechen</button>
                    </div>
                </div>
            </div>
        `;

        const renderPendingScreen = () => `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-100">
                <div class="retro-card p-8 w-full max-w-md text-center">
                    <div class="w-20 h-20 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center border-2 border-yellow-400 animate-pulse">
                        <i data-lucide="clock" class="w-10 h-10 text-yellow-600"></i>
                    </div>
                    <h2 class="text-3xl font-comic text-slate-800 mb-2">${t('pendingTitle')}</h2>
                    <p class="text-slate-600 mb-6">${t('pendingText')}</p>
                    <button onclick="signOutUser()" class="text-sm text-red-500 hover:underline font-bold">Abmelden</button>
                </div>
            </div>
        `;

        const renderMemberModal = (uid) => {
            const allPlayers = getAllPlayers();
            const u = allPlayers.find(p => p.id === uid);
            if (!u) return '';

            let wins = 0, losses = 0;
            let currentDebt = getLegacyDebt(u); 
            let totalDebt = getLegacyDebt(u); 

            games.forEach(g => {
                const isPen = g.type === 'game-penalty';
                if (isPen && g.playerId === uid) {
                    if (!g.paid) currentDebt += g.points;
                    totalDebt += g.points; 
                }
            });

            const skills = u.skills || {};
            const isSelf = userData && userData.id === u.id;
            
            let totalScore = 0;
            let validSkillsCount = 0;
            SKILL_LABELS.forEach(key => {
                if(skills[key]) {
                    totalScore += parseInt(skills[key]);
                    validSkillsCount++;
                }
            });
            const averageRating = validSkillsCount > 0 ? (totalScore / validSkillsCount) : 0;
            const roundedRating = Math.round(averageRating);

            const iconSrc = BG_BASE64 || "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Schelle.svg/60px-Schelle.svg.png";

            const renderStars = (score, max, interactive, skillKey) => {
                let html = '<div class="flex gap-1">';
                for(let i = 1; i <= max; i++) {
                    const isActive = i <= score;
                    const styleClass = isActive ? '' : 'filter: grayscale(100%) opacity(30%);';
                    const clickAttr = interactive ? `onclick="updateSkill('${u.id}', '${skillKey}', ${i})"` : '';
                    const cursorClass = interactive ? 'cursor-pointer hover:scale-110 transition-transform' : '';
                    html += `<img src="${iconSrc}" onerror="this.onerror=null; this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Schelle.svg/60px-Schelle.svg.png'" class="w-6 h-6 object-contain ${cursorClass}" style="${styleClass}" ${clickAttr} title="${i}/${max}">`;
                }
                html += '</div>';
                return html;
            };

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="closeModal(event)">
                <div class="retro-card p-0 w-full max-w-lg bg-white relative max-h-[90vh] overflow-y-auto animate-in">
                    <button onclick="closeModal(null, true)" class="absolute top-4 right-4 z-20 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 transition-colors duration-200 backdrop-blur-md flex items-center justify-center">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                    
                    <div class="bg-gradient-to-r from-red-800 to-red-950 h-32 relative mb-12 border-b-4 border-black">
                         <div class="absolute inset-0 opacity-40" style="background-image: url('${BG_BASE64}'); filter: grayscale(100%) brightness(0.5);"></div>
                         <div class="absolute -bottom-10 left-1/2 -translate-x-1/2 w-28 h-28 rounded-full border-4 border-white shadow-xl bg-white overflow-hidden">
                            <img src="${getAvatarUrl(u)}" onerror="this.src='${URL_FALLBACK}'" class="w-full h-full object-cover">
                         </div>
                    </div>

                    <div class="px-6 pb-6 text-center">
                        <h2 class="text-3xl font-comic text-slate-900 leading-none">${getFirstName(u)}</h2>
                        <p class="text-xs font-bold text-red-700 uppercase tracking-widest mb-2">${getTitle(u)}</p>
                        
                        <div class="inline-flex flex-col items-center gap-1 bg-amber-50 border border-amber-200 px-5 py-2 rounded-xl mb-6 shadow-sm">
                             <span class="text-amber-800 text-[10px] font-bold uppercase tracking-wider">Jass Skill Rating</span>
                             ${renderStars(roundedRating, 5, false, null)}
                        </div>

                        <div class="bg-slate-50 p-4 rounded-xl text-sm text-slate-600 italic mb-6 border border-slate-100 relative">
                            <span class="absolute top-2 left-2 text-4xl text-slate-200 font-serif leading-none">"</span>
                            ${u.bio || t('bioPlaceholder')}
                            <span class="absolute bottom-[-10px] right-2 text-4xl text-slate-200 font-serif leading-none">"</span>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="bg-slate-100 p-2 rounded border border-slate-200">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">${t('statsDebt')}</div>
                                <div class="text-2xl font-comic text-red-600">CHF ${currentDebt}</div>
                            </div>
                            <div class="bg-slate-100 p-2 rounded border border-slate-200">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">${t('statsWins')}/${t('statsLosses')}</div>
                                <div class="text-xl font-comic text-slate-800">${wins} / ${losses}</div>
                            </div>
                        </div>

                        <div class="bg-slate-50 rounded-xl p-5 border border-slate-100 mb-6">
                            <h4 class="font-bold text-xs uppercase text-slate-400 tracking-widest mb-4 text-center">FÃ¤higkeiten</h4>
                            <div class="space-y-2 text-left">
                                ${SKILL_LABELS.map(key => `
                                    <div class="flex items-center justify-between">
                                        <span class="font-bold text-slate-700 text-sm w-24">${t(key)}</span>
                                        ${renderStars(skills[key] || 0, 5, isSelf, key)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        ${isSelf ? `
                            <div class="border-t pt-4">
                                <label class="text-xs font-bold text-slate-400 uppercase mb-1 block text-left">Bio bearbeiten</label>
                                <input type="text" id="edit-bio" placeholder="Deine Bio..." class="retro-input w-full px-3 py-2 text-sm mb-2" value="${u.bio || ''}">
                                <button onclick="saveProfile('${u.id}')" class="retro-btn w-full py-2 text-sm">${t('updateProfile')}</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;
        };

        const renderStatistics = () => {
            const allPlayers = getAllPlayers(); 
            const scores = {};
            const debts = {};
            
            const allSeasons = [...new Set(games.map(g => g.season).filter(s => s))].sort().reverse();
            const viewingSeason = leaderboardFilter === 'season' ? currentSeasonId : null;

            allPlayers.forEach(u => { 
                if(u.role !== 'pending'){
                    scores[u.id] = 0; 
                    debts[u.id] = getLegacyDebt(u); 
                }
            });

            games.forEach(g => {
                if(!scores.hasOwnProperty(g.playerId)) return;
                const isPenalty = g.type === 'game-penalty';
                const isViewSeason = g.season === viewingSeason;
                
                if(isPenalty && !g.paid) debts[g.playerId] += (g.points||0);
                
                if(leaderboardFilter === 'season') { 
                    if(isViewSeason && !isPenalty) scores[g.playerId] += g.points; 
                } 
                else if(leaderboardFilter === 'history') { 
                    if(!isPenalty) scores[g.playerId] += g.points; 
                }
            });

            let displayData = [];
            if(leaderboardFilter === 'debt') {
                displayData = Object.entries(debts).map(([uid,val])=>({uid,val})).sort((a,b)=>a.val-b.val);
            } else {
                displayData = Object.entries(scores).map(([uid,val])=>({uid,val})).sort((a,b)=>b.val-a.val);
            }
            displayData = displayData.filter(d => allPlayers.find(u=>u.id===d.uid));

            const getSeasonWinner = (sId) => {
                const sScores = {};
                games.filter(g => g.season === sId && g.type !== 'game-penalty').forEach(g => {
                    sScores[g.playerId] = (sScores[g.playerId] || 0) + g.points;
                });
                const entries = Object.entries(sScores).sort((a,b)=>b[1]-a[1]);
                if(entries.length === 0) return null;
                const uid = entries[0][0];
                return { uid, score: entries[0][1], name: getFirstName(allPlayers.find(u=>u.id===uid)) || '?' };
            };

            const groupedGames = {};
            if (leaderboardFilter === 'history' || leaderboardFilter === 'season') {
                const targetGames = games.filter(g => leaderboardFilter==='history' || (leaderboardFilter==='season' && g.season===currentSeasonId));
                targetGames.forEach(g => {
                    if (!g.timestamp) return;
                    const date = g.timestamp.toDate();
                    const key = date.toLocaleDateString('de-CH'); 
                    if (!groupedGames[key]) groupedGames[key] = [];
                    groupedGames[key].push(g);
                });
            }

            return `
            <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 px-2 max-w-4xl mx-auto w-full">
                <div class="flex p-1 bg-slate-200 rounded-xl overflow-hidden border-2 border-black shadow-[4px_4px_0_rgba(0,0,0,0.1)]">
                    <button onclick="setFilter('debt')" class="flex-1 py-2 text-xs font-bold uppercase transition-colors ${leaderboardFilter==='debt'?'bg-white text-red-600 shadow-sm rounded-lg':'text-slate-500 hover:text-red-600'}">${t('filters.debt')}</button>
                    <button onclick="setFilter('season')" class="flex-1 py-2 text-xs font-bold uppercase transition-colors ${leaderboardFilter==='season'?'bg-white text-black shadow-sm rounded-lg':'text-slate-500 hover:text-black'}">${currentSeasonId}</button>
                    <button onclick="setFilter('history')" class="flex-1 py-2 text-xs font-bold uppercase transition-colors ${leaderboardFilter==='history'?'bg-white text-black shadow-sm rounded-lg':'text-slate-500 hover:text-black'}">${t('filters.history')}</button>
                </div>

                <!-- RANGLISTE -->
                ${leaderboardFilter === 'season' ? `<h4 class="text-center font-bold text-lg uppercase text-slate-800 -mb-2">Aktuelle Saison: ${currentSeasonId}</h4>` : ''}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${displayData.map((item, idx) => {
                        const u = allPlayers.find(user => user.id === item.uid);
                        if (!u) return '';
                        const isLeader = idx === 0 && item.val > 0 && leaderboardFilter !== 'debt';
                        const isDebt = leaderboardFilter === 'debt';
                        
                        return `
                            <div onclick="openMemberModal('${u.id}')" class="retro-card p-3 flex items-center gap-4 cursor-pointer hover:scale-[1.02] hover:shadow-xl transition-all active:scale-100 ${isLeader ? 'bg-yellow-50 border-yellow-500' : ''}">
                                <div class="absolute top-0 right-0 bg-black text-white px-2 py-1 rounded-bl-lg text-xs font-bold font-mono z-10">#${idx+1}</div>
                                <div class="avatar-card-frame shrink-0"><img src="${getAvatarUrl(u)}" onerror="this.src='${URL_FALLBACK}'" class="avatar-img-pinned"></div>
                                <div class="flex-1 py-1">
                                    <div class="flex flex-col">
                                        <div class="font-comic text-2xl text-slate-900 uppercase tracking-wide leading-none mb-1">${getFirstName(u)}</div>
                                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest border-b-2 border-slate-200 pb-2 mb-2 w-full">${getTitle(u)}</div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-[10px] font-bold uppercase text-slate-400">${isDebt?t('openDebt'):'Score'}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="font-comic text-3xl ${isDebt?'text-red-600':'text-slate-800'}">${isDebt?'CHF':''} ${item.val}</span>
                                            ${(isDebt && item.val > 0 && isAdmin() && !u.isVirtual) ? `<button onclick="event.stopPropagation(); payDebt('${u.id}')" class="bg-green-600 text-white p-1 rounded hover:bg-green-700 transition"><i data-lucide="check" class="w-4 h-4"></i></button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- ARCHIV & HISTORIE -->
                ${leaderboardFilter === 'season' ? `
                    <div class="mt-12 pt-6 border-t-4 border-slate-200">
                        <h4 class="font-comic text-2xl text-slate-400 uppercase mb-4 text-center">Saison Archiv</h4>
                        <div class="space-y-3">
                            ${allSeasons.filter(s => s !== currentSeasonId).map(s => {
                                const winner = getSeasonWinner(s);
                                return `
                                <div class="retro-card p-3 bg-slate-50 !border-slate-300 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="font-comic text-xl text-slate-600">${s}</div>
                                        ${winner ? `<div class="text-xs text-slate-500 font-bold bg-white px-2 py-1 rounded border border-slate-200">ðŸ† ${winner.name} (${winner.score})</div>` : ''}
                                    </div>
                                    <button onclick="viewArchiveSeason('${s}')" class="text-xs font-bold text-blue-500 hover:underline uppercase">Details</button>
                                </div>`;
                            }).join('') || '<div class="text-center text-slate-400 text-sm italic">Keine vergangenen Saisons.</div>'}
                        </div>
                    </div>
                ` : ''}

                ${(leaderboardFilter !== 'debt' && leaderboardFilter !== 'season') ? `
                    <div class="mt-8 border-t-2 border-slate-200 pt-4">
                        <h4 class="font-bold text-sm uppercase text-slate-500 mb-3">${t('filters.history')}</h4>
                        <div class="space-y-4 md:grid md:grid-cols-2 md:gap-4 md:space-y-0">
                            ${Object.entries(groupedGames).map(([dateStr, dayGames]) => `
                                <div class="bg-white rounded-xl border border-slate-300 overflow-hidden shadow-sm h-fit">
                                    <div class="bg-slate-100 p-3 flex justify-between items-center cursor-pointer hover:bg-slate-200" onclick="toggleDate('${dateStr}')">
                                        <span class="font-comic text-lg text-slate-800">${dateStr}</span>
                                        <span class="text-xs text-slate-500 font-bold uppercase bg-white px-2 py-1 rounded border border-slate-300">${dayGames.length} Spiele</span>
                                    </div>
                                    <div id="games-${dateStr}" class="p-2 space-y-2 ${expandedHistoryDates[dateStr] ? '' : 'hidden'}">
                                        ${dayGames.map(g => {
                                            const p = allPlayers.find(u => u.id === g.playerId);
                                            const isPen = g.type === 'game-penalty';
                                            return `
                                                <div class="flex items-center justify-between border-b border-slate-100 pb-2 last:border-0">
                                                    <div class="flex items-center gap-2">
                                                        <img src="${getAvatarUrl(p)}" onerror="this.src='${URL_FALLBACK}'" class="w-6 h-6 rounded-full border border-black bg-black">
                                                        <span class="text-sm font-bold ${isPen ? 'text-red-600' : 'text-slate-800'}">${getFirstName(p)}</span>
                                                    </div>
                                                    <div class="text-right flex items-center gap-2">
                                                        <div>
                                                            <div class="text-sm font-comic ${isPen ? 'text-red-600' : 'text-green-600'}">${isPen ? 'Strafe' : 'Sieg'}</div>
                                                            <div class="text-[10px] font-mono text-slate-400">
                                                                ${g.reason ? g.reason + ' (' + g.points + ')' : '+' + g.points + ' Pkt'}
                                                            </div>
                                                        </div>
                                                        ${isAdmin() ? `<button onclick="handleDeleteGame('${g.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('') || `<div class="text-center text-slate-400 italic">${t('noEntries')}</div>`}
                        </div>
                    </div>
                ` : ''}
            </div>`;
        };

        const renderEvents = () => {
            const allPlayers = getAllPlayers();
            const now = new Date();
            const confirmed = events.filter(e => e.status === 'confirmed' && e.date?.toDate() >= now);
            const polls = events.filter(e => e.status === 'poll' && e.date?.toDate() >= now);
            const canAction = isMember(); 

            return `
            <div class="space-y-6 animate-in fade-in duration-500 px-2 pb-24 max-w-4xl mx-auto w-full">
                <div class="flex items-center justify-between px-1">
                    <h3 class="text-3xl font-comic text-slate-900 transform -rotate-1">${t('tabs.events')}</h3>
                    ${isAdmin() ? `<button onclick="openCreateEventModal()" class="bg-black text-yellow-400 px-3 py-1 text-sm font-bold rounded border-2 border-yellow-400 shadow-md hover:scale-105 transition"><i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> ${t('createEvent')}</button>` : ''}
                </div>
                
                <!-- CONFIRMED EVENTS -->
                <div>
                    <h4 class="font-bold text-sm uppercase text-slate-500 mb-3 border-b-2 border-slate-200 pb-1">${t('nextEvents')}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${confirmed.length === 0 ? `<div class="text-slate-400 text-sm italic">${t('noEntries')}</div>` : 
                        confirmed.map(e => {
                            const date = e.date.toDate();
                            const host = allPlayers.find(u => u.id === e.hostId)?.name || 'Unbekannt';
                            return `
                            <div onclick="openEventDetails('${e.id}')" class="retro-card p-4 border-l-8 border-l-green-600 relative overflow-hidden cursor-pointer hover:scale-[1.01] transition-transform">
                                <div class="stamp-definitiv">${t('definitive')}</div>
                                <div class="flex justify-between items-start relative z-20">
                                    <div>
                                        <div class="text-3xl font-comic text-slate-800">${date.toLocaleDateString('de-CH', {day:'2-digit', month:'2-digit'})}</div>
                                        <div class="text-lg font-bold text-slate-600">${date.toLocaleDateString('de-CH', {weekday:'long'})} ${e.timeFrom || ''} ${e.timeTo ? '- '+e.timeTo : ''}</div>
                                        <div class="text-xs mt-2 font-mono bg-slate-100 px-2 py-1 rounded inline-block"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${e.location || 'TBD'} @ ${getFirstName({name:host})}</div>
                                    </div>
                                    <div class="flex -space-x-2">
                                        ${e.attendees.map(uid => `<img src="${getAvatarUrl(allPlayers.find(u=>u.id===uid)||{})}" onerror="this.src='${URL_FALLBACK}'" class="w-8 h-8 rounded-full border-2 border-white bg-black object-cover">`).join('')}
                                    </div>
                                </div>
                                ${isAdmin() ? `<button onclick="handleDeleteEvent('${e.id}')" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 z-30"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                
                <!-- POLLS -->
                ${polls.length > 0 ? `
                <div>
                    <h4 class="font-bold text-sm uppercase text-slate-500 mb-3 border-b-2 border-slate-200 pb-1 mt-6">${t('pollEvents')}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${polls.map(e => {
                            const date = e.date.toDate();
                            const isJoined = userData && e.attendees.includes(userData.id);
                            const count = e.attendees.length;
                            return `
                            <div class="retro-card p-3 flex items-center justify-between cursor-pointer hover:bg-slate-50" onclick="openEventDetails('${e.id}')">
                                <div>
                                    <div class="font-bold text-lg text-slate-800">${date.toLocaleDateString('de-CH', {weekday:'short', day:'2-digit', month:'2-digit'})}</div>
                                    <div class="text-xs text-slate-500">${e.location || 'TBD'}</div>
                                    <div class="mt-1 flex items-center gap-1">
                                        ${[...Array(4)].map((_, i) => `<div class="w-2 h-2 rounded-full ${i < count ? 'bg-green-500' : 'bg-slate-200'}"></div>`).join('')}
                                        <span class="text-[10px] text-slate-400 ml-1">${count}/?</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="px-4 py-2 rounded-lg font-bold text-xs uppercase border-2 border-black shadow-[2px_2px_0_black] transition-all active:translate-y-0.5 active:shadow-none ${canAction ? (isJoined ? 'bg-green-100 text-green-700' : 'bg-white text-black') : 'bg-slate-200 text-slate-400'}">
                                        ${isJoined ? 'Dabei' : 'Antworten'}
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>` : ''}
            </div>`;
        };

        const renderMembers = () => {
            const allPlayers = getAllPlayers();
            return `
            <div class="space-y-4 animate-in fade-in duration-500 px-2 pb-24 max-w-4xl mx-auto w-full">
                <div class="flex items-center justify-between px-1 mb-2">
                    <h3 class="text-3xl font-comic text-slate-900 transform -rotate-1">${t('tabs.members')}</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${allPlayers.filter(u => u.role !== 'pending').map(u => `
                        <div class="retro-card p-2 flex flex-col items-center text-center cursor-pointer hover:border-yellow-400 hover:shadow-lg transition-all" onclick="openMemberModal('${u.id}')">
                            <div class="avatar-card-frame mb-2"><img src="${getAvatarUrl(u)}" onerror="this.src='${URL_FALLBACK}'" class="avatar-img-pinned"></div>
                            <div class="font-bold text-sm uppercase leading-tight">${getFirstName(u)}</div>
                            <div class="text-[10px] text-slate-500 mt-1 px-2 py-0.5 bg-slate-100 rounded-full">${getTitle(u)}</div>
                            <div class="text-[9px] text-yellow-600 font-bold mt-1 uppercase">${u.role === 'patron' ? t('rolePatron').split(' ')[0] : t('roleActive').split(' ')[0]}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${isMember() ? `
                <div class="retro-card bg-slate-100 p-4 mt-8 !border-slate-300 md:w-1/2 md:mx-auto">
                    <h4 class="font-bold text-sm uppercase mb-2 flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> ${t('paymentInfo')}</h4>
                    <div class="text-xs font-mono space-y-1 text-slate-600">
                        <p>Twint: 078 816 63 50</p>
                        <p>IBAN: CH39 0878 1000 2448 0910 0</p>
                        <p>Beitrag Aktiv: CHF 30.00 pro Monat</p>
                        <p>Beitrag GÃ¶nner: CHF 1000.00 pro Jahr</p>
                    </div>
                </div>` : `
                <div class="px-4 py-6 text-center animate-in fade-in">
                    <div class="retro-card p-4 bg-slate-50 border-dashed md:w-1/2 md:mx-auto">
                        <h3 class="font-comic text-xl text-slate-800 mb-2">${t('memberRestricted')}</h3>
                        <p class="text-sm text-slate-500 mb-2">${t('memberRestrictedText')}</p>
                        <button onclick="openLoginModal()" class="text-xs font-bold text-blue-600 underline">${t('guestHint')}</button>
                    </div>
                </div>
                `}
            </div>`;
        };

        const renderCalculator = () => {
            const allPlayers = getAllPlayers();
            if (!isActiveMember()) return `
                <div class="px-4 py-12 text-center animate-in fade-in">
                    <div class="retro-card p-8 bg-slate-50 border-dashed max-w-md mx-auto">
                        <i data-lucide="lock" class="w-12 h-12 mx-auto text-slate-300 mb-4"></i>
                        <h3 class="font-comic text-xl text-slate-800 mb-2">${t('calcTitle')}</h3>
                        <p class="text-sm text-slate-500 mb-6">${t('matchRestricted')}</p>
                    </div>
                </div>`;
            
            if (allPlayers.filter(u=>u.role!=='pending').length < 4) return `<div class="p-8 text-center text-slate-500">Min. 4 Member nÃ¶tig.</div>`;
            
            if (calculatorState.activeStep === 'setup') return `
                <div class="retro-card p-0 animate-in zoom-in-95 mx-2 overflow-hidden max-w-2xl mx-auto w-full">
                    <div class="bg-slate-100 p-4 border-b-4 border-black text-center"><h2 class="text-3xl font-comic text-slate-800">${t('calcTitle')}</h2></div>
                    <div class="p-6 space-y-6 bg-white flex flex-col items-center">
                        ${[1, 2].map(teamNum => `
                            <div class="space-y-3 w-full text-center">
                                <div class="inline-block px-4 py-1 bg-black text-white text-sm font-bold uppercase transform -rotate-1 rounded shadow-md">Team ${teamNum}</div>
                                <div class="flex flex-wrap justify-center gap-3">
                                    ${allPlayers.filter(u=>u.role!=='pending').map(p => `
                                        <button onclick="toggleTeamSelection('${p.id}', ${teamNum})" 
                                            class="w-20 h-24 p-2 rounded-xl border-2 transition-all font-bold text-sm flex flex-col items-center justify-between gap-1 overflow-hidden relative shadow-sm
                                            ${calculatorState[`team${teamNum}`].includes(p.id) ? (teamNum===1 ? 'border-blue-600 bg-blue-50 text-blue-700 shadow-[2px_2px_0_#2563eb] scale-105' : 'border-red-600 bg-red-50 text-red-700 shadow-[2px_2px_0_#dc2626] scale-105') : calculatorState[teamNum===1?'team2':'team1'].includes(p.id) ? 'opacity-30 border-slate-200 cursor-not-allowed grayscale' : 'border-slate-200 text-slate-600 hover:border-slate-400 hover:-translate-y-1 bg-white'}">
                                            <div class="w-12 h-12 rounded-full overflow-hidden border border-black bg-black"><img src="${getAvatarUrl(p)}" onerror="this.src='${URL_FALLBACK}'" class="w-full h-full object-cover object-bottom"></div>
                                            <span class="uppercase text-[10px] truncate w-full text-center leading-none">${getFirstName(p)}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        <div class="w-full pt-4 border-t border-slate-100 mt-2">
                            <button onclick="startCalculatorGame()" ${(calculatorState.team1.length !== 2 || calculatorState.team2.length !== 2) ? 'disabled' : ''}
                                class="w-full py-4 retro-btn text-xl shadow-lg ${(calculatorState.team1.length !== 2 || calculatorState.team2.length !== 2) ? '!bg-slate-200 !text-slate-400 !border-slate-300 !shadow-none cursor-not-allowed' : 'hover:scale-105'}">${t('start')}</button>
                        </div>
                    </div>
                </div>`;
            
            if (calculatorState.activeStep === 'play') {
                const t1Members = calculatorState.team1.map(uid => allPlayers.find(u => u.id === uid));
                const t2Members = calculatorState.team2.map(uid => allPlayers.find(u => u.id === uid));
                
                const sumPoints = (teamIdx) => calculatorState.rounds.reduce((acc, r) => {
                    const cardPts = teamIdx === 1 ? r.pA : r.pB;
                    const val = cardPts === 157 ? 257 : cardPts;
                    const weis = teamIdx === 1 ? r.wA : r.wB;
                    return acc + (val * r.mult) + (weis * r.mult); 
                }, 0);

                const totalA = sumPoints(1);
                const totalB = sumPoints(2);

                return `
                <div class="flex flex-col h-full animate-in fade-in duration-300 pb-24 px-2 max-w-2xl mx-auto w-full items-center">
                    
                    <div class="w-full grid grid-cols-2 gap-3 mb-4">
                        <div class="flex flex-col gap-1 items-center">
                            <div class="flex justify-center gap-1 mb-1">
                                ${t1Members.map(m => `
                                    <div class="w-16 h-16 rounded-full border-2 border-black bg-black overflow-hidden shadow-sm" title="${m?.name}">
                                        <img src="${getAvatarUrl(m)}" onerror="this.src='${URL_FALLBACK}'" class="w-full h-full object-cover object-bottom">
                                    </div>
                                `).join('')}
                            </div>
                            <div class="retro-card w-full bg-blue-50 p-2 text-center !border-blue-800 !shadow-[4px_4px_0_#1e40af]">
                                <div class="text-xs uppercase font-bold text-blue-300 mb-1 tracking-widest">Team Blau</div>
                                <div class="text-5xl font-comic text-blue-900">${totalA}</div>
                            </div>
                        </div>

                        <div class="flex flex-col gap-1 items-center">
                            <div class="flex justify-center gap-1 mb-1">
                                ${t2Members.map(m => `
                                    <div class="w-16 h-16 rounded-full border-2 border-black bg-black overflow-hidden shadow-sm" title="${m?.name}">
                                        <img src="${getAvatarUrl(m)}" onerror="this.src='${URL_FALLBACK}'" class="w-full h-full object-cover object-bottom">
                                    </div>
                                `).join('')}
                            </div>
                            <div class="retro-card w-full bg-red-50 p-2 text-center !border-red-800 !shadow-[4px_4px_0_#991b1b]">
                                <div class="text-xs uppercase font-bold text-red-300 mb-1 tracking-widest">Team Rot</div>
                                <div class="text-5xl font-comic text-red-900">${totalB}</div>
                            </div>
                        </div>
                    </div>

                    <div class="retro-card p-4 mb-4 bg-white w-full">
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${TRUMP_MODES.map(t => `
                                <button onclick="selectTrump('${t.id}')" 
                                    class="flex flex-col items-center justify-center p-2 rounded border-2 transition-all ${calculatorState.selectedTrump === t.id ? 'bg-slate-800 text-white border-slate-900 shadow-inner' : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-white'}">
                                    <span class="text-2xl">${t.icon}</span>
                                    <span class="text-[10px] font-bold uppercase mt-1">${t.label} <span class="bg-yellow-400 text-black px-1 rounded text-[9px] ml-1">${t.mult}x</span></span>
                                </button>
                            `).join('')}
                        </div>

                        <div class="grid grid-cols-[1fr,auto,1fr] gap-3 items-end mb-4">
                            <div class="relative">
                                <label class="block text-[10px] font-bold text-blue-900 uppercase text-center mb-1">Karten</label>
                                <input type="number" id="input-points-a" oninput="calculatePoints('a')" placeholder="0" class="retro-input w-full h-14 text-center text-3xl text-blue-900 placeholder-blue-200">
                            </div>
                            <div class="font-comic text-2xl text-slate-400 pb-3">VS</div>
                            <div class="relative">
                                <label class="block text-[10px] font-bold text-red-900 uppercase text-center mb-1">Karten</label>
                                <input type="number" id="input-points-b" oninput="calculatePoints('b')" placeholder="0" class="retro-input w-full h-14 text-center text-3xl text-red-900 placeholder-red-200">
                            </div>
                        </div>
                        
                        <div class="mb-4 px-2">
                            <input type="range" id="slider-points" min="0" max="157" value="0" oninput="updateFromSlider(this.value)">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="relative">
                                <label class="block text-[10px] font-bold text-blue-400 uppercase text-center mb-1">Weis (Separat)</label>
                                <input type="number" id="input-weis-a" placeholder="0" class="text-center w-full text-lg font-mono border-b-2 border-slate-300 bg-transparent py-1 focus:outline-none focus:border-blue-500">
                            </div>
                            <div class="relative">
                                <label class="block text-[10px] font-bold text-red-400 uppercase text-center mb-1">Weis (Separat)</label>
                                <input type="number" id="input-weis-b" placeholder="0" class="text-center w-full text-lg font-mono border-b-2 border-slate-300 bg-transparent py-1 focus:outline-none focus:border-red-500">
                            </div>
                        </div>
                        
                        <button onclick="submitRound()" class="w-full retro-btn text-xl py-4 shadow-lg hover:translate-y-[-2px] transition-transform">Punkte Buchen</button>
                    </div>

                    <div class="w-full mb-20">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h4 class="font-bold text-xs uppercase text-slate-400">Verlauf</h4>
                            ${calculatorState.rounds.length > 0 ? `<button onclick="undoLastRound()" class="text-xs font-bold text-red-500 hover:underline flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> RÃ¼ckgÃ¤ngig</button>` : ''}
                        </div>
                        <div class="space-y-2">
                            ${calculatorState.rounds.map((r, i) => {
                                const mode = TRUMP_MODES.find(t => t.id === r.trumpId);
                                return `
                                <div class="retro-card p-2 flex items-center justify-between text-xs !min-h-0 !rounded-lg border-2">
                                    <div class="flex items-center gap-2 w-16">
                                        <span class="text-lg">${mode?.icon || '?'}</span>
                                        <span class="font-bold bg-black text-white px-1 rounded">${r.mult}x</span>
                                    </div>
                                    <div class="flex-1 grid grid-cols-2 gap-2 text-center">
                                        <div class="text-blue-900 font-mono">
                                            <span class="font-bold">${r.pA === 157 ? 257 : r.pA}</span>
                                            ${r.wA > 0 ? `<span class="text-[10px] text-blue-400 ml-1">+${r.wA}</span>` : ''}
                                        </div>
                                        <div class="text-red-900 font-mono">
                                            <span class="font-bold">${r.pB === 157 ? 257 : r.pB}</span>
                                            ${r.wB > 0 ? `<span class="text-[10px] text-red-400 ml-1">+${r.wB}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="editRound(${i})" class="text-slate-400 hover:text-blue-500 p-1"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                        <div class="w-4 text-right font-bold text-slate-300">#${i+1}</div>
                                    </div>
                                </div>`;
                            }).reverse().join('')}
                        </div>
                    </div>
                    
                    <div class="fixed bottom-4 left-0 right-0 px-4 text-center z-50 md:static md:px-0">
                         <button onclick="abortGame()" class="bg-white border-2 border-slate-300 text-slate-400 px-4 py-2 rounded-full text-xs font-bold uppercase shadow-sm hover:text-red-500 hover:border-red-300 transition-colors">Spiel Abbrechen</button>
                    </div>
                </div>`;
            }
            
            // Finish Screen
            return `
             <div class="retro-card p-8 animate-in zoom-in-95 mx-2 text-center border-t-8 border-t-yellow-400">
                <h2 class="text-4xl font-comic text-slate-900 mb-2 uppercase">${t('finish')}</h2>
                
                <div class="bg-red-50 border-2 border-dashed border-red-300 rounded-xl p-4 mb-6 text-left">
                    <h3 class="font-black text-red-700 text-xs uppercase tracking-wide mb-3 flex items-center gap-2"><i data-lucide="alert-octagon" class="w-4 h-4"></i> Abrechnung & Strafen</h3>
                    <ul class="space-y-2">
                        ${calculatorState.penalties.length === 0 ? '<li class="text-sm text-slate-400 italic">Keine Strafen</li>' : 
                        calculatorState.penalties.map(p => {
                            const pl = allPlayers.find(u => u.id === p.playerId);
                            return `<li class="flex justify-between items-center text-sm border-b border-red-200 pb-2 last:border-0">
                                <span>${getFirstName(pl)}</span>
                                <div class="text-right">
                                    <span class="block font-bold text-red-600">+ CHF ${p.amount}</span>
                                    <span class="text-[10px] text-red-400 uppercase">${p.reason}</span>
                                </div>
                            </li>`
                        }).join('')}
                    </ul>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-xs text-slate-500 uppercase tracking-widest mb-1">Gewinner</div>
                    <div class="font-comic text-2xl text-green-600">
                        ${calculatorState.winnerTeam === 1 ? 'Team Blau' : 'Team Rot'}
                    </div>
                </div>

                <button onclick="saveCalculatedGame()" class="w-full retro-btn-secondary retro-btn text-xl py-3">${t('save')}</button>
             </div>`;
        };

        const renderAdminPanel = () => {
            if (!isAdmin()) return '<div class="p-8 text-center font-comic">Access Denied</div>';
            return `
            <div class="space-y-6 animate-in fade-in duration-500 px-2 pb-24 max-w-4xl mx-auto w-full">
                <h3 class="text-3xl font-comic text-slate-900 transform -rotate-1 mb-4">${t('adminArea')}</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- SEASON MANAGEMENT -->
                    <div class="retro-card p-4 border-l-8 border-l-black h-fit">
                        <h4 class="font-bold text-sm uppercase mb-3 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Saison Verwaltung</h4>
                        
                        <div class="mb-4">
                            <div class="text-xs text-slate-500 font-bold uppercase">Aktuelle Saison</div>
                            <div class="text-2xl font-comic text-green-600">${currentSeasonId}</div>
                        </div>

                        <div class="border-t pt-3">
                            <label class="text-xs text-slate-500 font-bold uppercase block mb-1">Neue Saison Starten</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-season-input" placeholder="z.B. 2026" class="retro-input flex-1 px-3 py-2">
                                <button onclick="updateSeason()" class="retro-btn py-2 px-3 text-xs">ErÃ¶ffnen</button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2">
                                <i data-lucide="info" class="w-3 h-3 inline mr-1"></i> 
                                "ErÃ¶ffnen" archiviert die alte Saison automatisch.
                            </p>
                        </div>
                    </div>

                    <div class="retro-card p-4 border-l-8 border-l-yellow-400 h-fit">
                        <h4 class="font-bold text-sm uppercase mb-3 flex items-center gap-2"><i data-lucide="user-plus" class="w-4 h-4"></i> Anfragen (${pendingUsers.length})</h4>
                        ${pendingUsers.map(u => `
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-3 bg-slate-50 border border-slate-200 rounded-lg mb-2">
                                <div class="flex items-center gap-3"><img src="${getAvatarUrl(u)}" class="w-10 h-10 rounded-full border border-black"><div><div class="font-bold">${u.name}</div><div class="text-xs text-slate-500">${u.email || ''}</div></div></div>
                                <div class="flex gap-2">
                                    <button onclick="approveUser('${u.id}', 'active')" class="retro-btn retro-btn-success py-1 px-3 text-xs">Aktiv</button>
                                    <button onclick="approveUser('${u.id}', 'patron')" class="retro-btn retro-btn-secondary py-1 px-3 text-xs">GÃ¶nner</button>
                                    <button onclick="rejectUser('${u.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>`).join('') || '<div class="text-sm text-slate-400">Keine.</div>'}
                    </div>
                </div>
            </div>`;
        };

        const renderApp = () => {
            let tabs = { leaderboard: "Statistik", events: "Events", calculator: "Match", members: "Member" };
            if (isAdmin()) tabs['admin'] = "Admin";

            document.getElementById('app').innerHTML = `
                ${(!user && activeTab === 'members' && !window.guestMode) ? renderLoginModal() : ''} 
                ${(user && !userData) ? renderRegistration() : ''}
                ${(userData && userData.role === 'pending') ? renderPendingScreen() : `
                ${renderHeader()}
                <main class="max-w-6xl mx-auto -mt-8 relative z-10 min-h-screen flex flex-col">
                    <div class="hidden md:flex justify-center gap-2 -mt-4 relative z-20 mb-8 px-2 flex-wrap">
                        ${Object.keys(tabs).map(k => `<button onclick="setActiveTab('${k}')" class="px-5 py-2 rounded border-2 border-black font-comic text-lg uppercase shadow-[3px_3px_0_black] hover:translate-y-[1px] hover:shadow-[1px_1px_0_black] transition-all bg-white ${activeTab===k?'tab-btn-active':''}">${t('tabs.'+k)}</button>`).join('')}
                    </div>
                    ${
                      activeTab === 'leaderboard' ? renderStatistics() :
                      activeTab === 'events' ? renderEvents() :
                      activeTab === 'members' ? renderMembers() :
                      activeTab === 'calculator' ? renderCalculator() :
                      activeTab === 'admin' ? renderAdminPanel() : ''
                    }
                    <footer class="text-center py-8 text-slate-400 text-xs pb-32 md:pb-8 relative z-10 font-mono">
                        <div class="flex justify-center gap-4 mb-2">
                            <button onclick="setLang('de')" class="${currentLang==='de'?'text-black font-bold':'text-slate-400'}">DE</button>
                            <button onclick="setLang('en')" class="${currentLang==='en'?'text-black font-bold':'text-slate-400'}">EN</button>
                        </div>
                        <p class="uppercase tracking-widest">&copy; 2025 Jassgenossen SchÃ¤llebur</p>
                    </footer>
                </main>
                <nav id="mobile-nav" class="fixed bottom-4 left-4 right-4 bg-white border-4 border-black rounded-xl shadow-[6px_6px_0_rgba(0,0,0,0.5)] px-2 py-2 flex justify-around items-center z-50 md:hidden transition-all duration-300">
                     ${Object.keys(tabs).map(k => {
                        const isActive = activeTab === k;
                        const icons = { leaderboard: 'trophy', calculator: 'calculator', events: 'calendar', members: 'users', admin: 'shield' };
                        return `<button onclick="setActiveTab('${k}')" class="flex flex-col items-center gap-1 p-2 rounded-lg transition-all ${isActive ? 'bg-black text-yellow-400 transform -translate-y-1 shadow-[2px_2px_0_#d80018]' : 'text-slate-400 hover:text-slate-800'}"><i data-lucide="${icons[k]}" class="w-5 h-5 ${isActive ? 'fill-current' : ''}"></i></button>`;
                    }).join('')}
                </nav>
                `}
                ${(!user && !userData && !window.guestMode && !['leaderboard','events','members'].includes(activeTab)) ? renderLoginModal() : ''} 
            `;
            if (window.lucide) window.lucide.createIcons();
            window.removeEventListener('scroll', handleScroll);
            window.addEventListener('scroll', handleScroll);
        };

        // --- F. ACTIONS ---
        window.openLoginModal = () => { document.getElementById('modal-container').innerHTML = renderLoginModal(); if (window.lucide) window.lucide.createIcons(); };
        window.closeModal = (e, force) => { if (force || e.target.id === 'modal-container') document.getElementById('modal-container').innerHTML = ''; };
        window.toggleDate = (date) => { expandedHistoryDates[date] = !expandedHistoryDates[date]; renderApp(); };
        window.setLang = (l) => { currentLang = l; renderApp(); };
        window.setRegRole = (r) => { registrationRole = r; renderApp(); };
        
        window.setActiveTab = (t) => { 
            activeTab = t; 
            renderApp(); 
            window.scrollTo(0,0); 
        };
        window.setFilter = (f) => { leaderboardFilter = f; renderApp(); };
        window.viewArchiveSeason = (sId) => { 
            currentSeasonId = sId; 
            leaderboardFilter = 'season';
            renderApp();
        };
        
        window.loginGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); closeModal(null,true); } catch(e) { alert("Login Error: " + e.message); } };
        
        window.loginGuestAndRedirect = async () => { 
            window.guestMode = true;
            closeModal(null,true);
            renderApp();
        }; 
        
        window.signOutUser = async () => { await signOut(auth); userData = null; window.guestMode = false; window.location.reload(); };
        
        window.completeRegistration = async () => {
            const name = document.getElementById('reg-name').value;
            const role = registrationRole; 
            if(!name) return;
            const isAdmin = user.email && ADMIN_EMAILS.includes(user.email);
            
            let roleKey = '';
            const legacy = LEGACY_DEBTS.find(l => 
                (user.email && l.email && user.email.toLowerCase() === l.email.toLowerCase()) || 
                (name && name.toLowerCase().includes(l.name.toLowerCase()))
            );
            if(legacy) roleKey = legacy.roleKey;

            await setDoc(doc(db, COLLECTIONS.USERS, user.uid), {
                id: user.uid, name, role: isAdmin ? 'admin' : 'pending',
                roleName: role === 'active' ? 'Aktivmitglied' : 'GÃ¶nner',
                avatar: user.photoURL || '', joined: serverTimestamp(),
                email: user.email || '',
                roleKey: roleKey
            });
        };
        
        window.approveUser = async (uid, r) => { await updateDoc(doc(db, COLLECTIONS.USERS, uid), { role: r, roleName: r === 'active' ? 'Aktivmitglied' : 'GÃ¶nner' }); };
        window.rejectUser = async (uid) => { if(confirm("User lÃ¶schen?")) await deleteDoc(doc(db, COLLECTIONS.USERS, uid)); };
        
        window.openMemberModal = (uid) => { document.getElementById('modal-container').innerHTML = renderMemberModal(uid); if (window.lucide) window.lucide.createIcons(); };
        window.updateSkill = async (uid, key, val) => {
             const skillUpdate = {};
             skillUpdate[`skills.${key}`] = parseInt(val);
             await updateDoc(doc(db, COLLECTIONS.USERS, uid), skillUpdate);
             setTimeout(() => window.openMemberModal(uid), 100); 
        };
        window.saveProfile = async (uid) => {
            const bio = document.getElementById('edit-bio').value;
            await updateDoc(doc(db, COLLECTIONS.USERS, uid), { bio: bio });
            closeModal(null, true);
        };

        window.updateSeason = async () => {
            const newSeason = document.getElementById('new-season-input').value;
            if(newSeason) {
                if(confirm(`Neue Saison "${newSeason}" starten? Die aktuelle Saison wird archiviert.`)) {
                    await setDoc(doc(db, COLLECTIONS.SETTINGS, 'config'), { currentSeason: newSeason }, { merge: true });
                    alert("Neue Saison gestartet!");
                }
            }
        };

        window.openCreateEventModal = () => { document.getElementById('modal-container').innerHTML = renderCreateEventModal(); if (window.lucide) window.lucide.createIcons(); };
        
        // --- NEW CALENDAR LOGIC ACTIONS ---
        window.openEventDetails = (eid) => { document.getElementById('modal-container').innerHTML = renderEventDetailsModal(eid); if (window.lucide) window.lucide.createIcons(); };
        window.downloadICSForEvent = (eid) => { const e = events.find(x => x.id === eid); if(e) downloadICS(e); };

        // ADMIN EVENT MANAGEMENT
        window.enableEditMode = (eid) => { editEventId = eid; window.openEventDetails(eid); };
        
        window.updateEventData = async (eid) => {
            const d = document.getElementById('edit-date').value;
            const t1 = document.getElementById('edit-time-from').value;
            const t2 = document.getElementById('edit-time-to').value;
            const loc = document.getElementById('edit-loc').value;
            
            if(!d || !t1) return;
            
            const eventRef = doc(db, COLLECTIONS.EVENTS, eid);
            await updateDoc(eventRef, {
                date: new Date(d+'T'+t1),
                timeFrom: t1, timeTo: t2, location: loc
            });
            
            editEventId = null;
            closeModal(null,true);
            
            // SEND UPDATE EMAIL TO PARTICIPANTS
            const event = events.find(e => e.id === eid);
            const attendees = event.attendees || [];
            if(attendees.length > 0) {
                const participantEmails = users.filter(u => attendees.includes(u.id) && u.email).map(u => u.email);
                if(participantEmails.length > 0) {
                    const subject = `UPDATE: Jass am ${new Date(d).toLocaleDateString('de-CH')}`;
                    const body = `Hoi zÃ¤me\n\nEs gab eine Anpassung beim Termin!\n\nNeues Datum: ${new Date(d).toLocaleDateString('de-CH')}\nZeit: ${t1} Uhr\nOrt: ${loc}\n\nBitte prÃ¼fen!`;
                    // Deep Link
                    const baseUrl = window.location.href.split('?')[0];
                    const link = `${baseUrl}?eid=${eid}`;
                    await sendSystemEmail(participantEmails, subject, body, link);
                }
            } else {
                alert("Event aktualisiert (keine Teilnehmer zu benachrichtigen).");
            }
        };

        window.forceRemoveUserFromEvent = async (eid, uid) => {
            if(!confirm("Diesen User wirklich austragen?")) return;
            const eventRef = doc(db, COLLECTIONS.EVENTS, eid);
            const snap = await getDoc(eventRef);
            let att = snap.data().attendees || [];
            att = att.filter(id => id !== uid);
            await updateDoc(eventRef, { attendees: att, status: 'poll' }); // Set back to poll if someone is removed
            window.openEventDetails(eid); // Refresh modal
        };

        window.submitNewEvent = async () => {
            const d = document.getElementById('new-event-date').value;
            const t1 = document.getElementById('new-event-time-from').value;
            const t2 = document.getElementById('new-event-time-to').value;
            const loc = document.getElementById('new-event-loc').value;
            const hostId = document.getElementById('new-event-host').value;
            
            if(!d || !t1) return;
            
            // a) Save
            const docRef = await addDoc(collection(db, COLLECTIONS.EVENTS), {
                date: new Date(d+'T'+t1),
                timeFrom: t1, timeTo: t2, location: loc, hostId: hostId, 
                attendees: [user.uid], declined: [], status: 'confirmed', season: currentSeasonId 
            });
            
            // b) Generate Link
            const baseUrl = window.location.href.split('?')[0];
            const inviteLink = `${baseUrl}?eid=${docRef.id}`;
            
            // c) Prepare Emails
            const allActiveEmails = users.filter(u => (u.role === 'active' || u.role === 'admin') && u.email).map(u => u.email);
            const hostName = getFirstName({name: users.find(u => u.id === hostId)?.name || 'Einem Host'});
            const subject = `Neue Jass-Runde: ${new Date(d).toLocaleDateString('de-CH')}`;
            const body = `Hoi Jassgenossen\n\nEin neuer Termin steht!\n\nDatum: ${new Date(d).toLocaleDateString('de-CH')}\nZeit: ${t1} Uhr\nOrt: ${loc} (bei ${hostName})\n\nBitte hier direkt an/abmelden:`;
            
            closeModal(null,true); 
            
            // d) Automatischer Versand
            await sendSystemEmail(allActiveEmails, subject, body, inviteLink);
        };

        window.updateEventStatus = async (eid, status) => {
            const ref = doc(db, COLLECTIONS.EVENTS, eid);
            const snap = await getDoc(ref);
            if(!snap.exists()) return;
            
            let data = snap.data();
            let attendees = data.attendees || [];
            let declined = data.declined || [];
            
            attendees = attendees.filter(id => id !== user.uid);
            declined = declined.filter(id => id !== user.uid);
            
            if (status === 'join') attendees.push(user.uid);
            if (status === 'decline') declined.push(user.uid);
            
            let newStatus = data.status || 'poll'; // Default to poll until full
            let justConfirmed = false;
            
            if (status === 'join' && attendees.length === 4) {
                newStatus = 'confirmed';
                justConfirmed = true; 
            }

            await updateDoc(ref, { attendees, declined, status: newStatus });
            
            if(document.getElementById('modal-container').innerHTML !== '') {
                window.openEventDetails(eid);
            }

            // AUTO-EMAIL BEI 4 SPIELERN
            if(justConfirmed) {
                const baseUrl = window.location.href.split('?')[0];
                const eventLink = `${baseUrl}?eid=${eid}`;

                const dObj = data.date.toDate();
                const dStr = dObj.toLocaleDateString('de-CH');
                
                // EmpfÃ¤nger: Nur die 4 Teilnehmer
                const participantEmails = users.filter(u => attendees.includes(u.id) && u.email).map(u => u.email);
                
                const subject = `DEFINITIV: Jass am ${dStr}`;
                const body = `Die Runde ist komplett!\n\nDatum: ${dStr}\nStart: ${data.timeFrom} Uhr\nLocation: ${data.location}\n\nTermin Details & Kalender-Export hier:`;
                
                await sendSystemEmail(participantEmails, subject, body, eventLink);
            }
        };

        // --- CALCULATOR & OTHER ACTIONS ---
        
        window.toggleTeamSelection = (pid, team) => {
            const other = team === 1 ? 2 : 1;
            const myArr = calculatorState[`team${team}`];
            const otherArr = calculatorState[`team${other}`];
            if (myArr.includes(pid)) calculatorState[`team${team}`] = myArr.filter(id => id !== pid);
            else if (!otherArr.includes(pid) && myArr.length < 2) calculatorState[`team${team}`].push(pid);
            renderApp();
        };
        window.startCalculatorGame = () => { 
            calculatorState.activeStep = 'play'; 
            calculatorState.rounds = []; 
            calculatorState.penalties = []; 
            calculatorState.selectedTrump = 'eichel';
            renderApp(); 
        };
        window.selectTrump = (id) => { calculatorState.selectedTrump = id; renderApp(); };
        window.updateFromSlider = (val) => {
            document.getElementById('input-points-a').value = val;
            calculatePoints('a');
        };
        window.calculatePoints = (src) => {
            const inA = document.getElementById('input-points-a');
            const inB = document.getElementById('input-points-b');
            const slider = document.getElementById('slider-points');
            
            let val = parseInt(src==='a'?inA.value:inB.value);
            if(isNaN(val)) val = 0;
            if (val > 157) val = 157; 
            
            if (src==='a') {
                inA.value = val;
                inB.value = 157 - val;
                if(slider) slider.value = val;
            } else {
                inB.value = val;
                inA.value = 157 - val;
                if(slider) slider.value = 157 - val;
            }
        };
        window.submitRound = () => {
            const pA_in = parseInt(document.getElementById('input-points-a').value) || 0;
            const pB_in = parseInt(document.getElementById('input-points-b').value) || 0;
            const wA = parseInt(document.getElementById('input-weis-a').value) || 0;
            const wB = parseInt(document.getElementById('input-weis-b').value) || 0;
            
            if (pA_in + pB_in !== 157) return alert("Punkte mÃ¼ssen 157 ergeben!");
            
            const trump = TRUMP_MODES.find(t => t.id === calculatorState.selectedTrump);
            const mult = trump ? trump.mult : 1;

            calculatorState.rounds.push({ 
                pA: pA_in, pB: pB_in, 
                wA: wA, wB: wB, 
                mult: mult, 
                trumpId: calculatorState.selectedTrump 
            });

            document.getElementById('input-points-a').value = '';
            document.getElementById('input-points-b').value = '157';
            document.getElementById('input-weis-a').value = '';
            document.getElementById('input-weis-b').value = '';
            document.getElementById('slider-points').value = 0;

            checkGameEnd();
            renderApp();
        };
        
        window.undoLastRound = () => {
            if(calculatorState.rounds.length > 0) {
                calculatorState.rounds.pop();
                renderApp();
            }
        };
        
        window.editRound = (index) => {
            const r = calculatorState.rounds[index];
            setTimeout(() => {
                document.getElementById('input-points-a').value = r.pA;
                document.getElementById('input-points-b').value = r.pB;
                document.getElementById('input-weis-a').value = r.wA || '';
                document.getElementById('input-weis-b').value = r.wB || '';
                if(document.getElementById('slider-points')) document.getElementById('slider-points').value = r.pA;
            }, 50);
            
            calculatorState.selectedTrump = r.trumpId;
            calculatorState.rounds.splice(index, 1);
            renderApp();
        };

        const checkGameEnd = () => {
            const sumPts = (tIdx) => calculatorState.rounds.reduce((acc, r) => {
                const cardPts = tIdx === 1 ? r.pA : r.pB;
                const val = cardPts === 157 ? 257 : cardPts;
                const weis = tIdx === 1 ? r.wA : r.wB;
                return acc + (val * r.mult) + (weis * r.mult);
            }, 0);

            const s1 = sumPts(1);
            const s2 = sumPts(2);

            if (s1 >= 2500 || s2 >= 2500) {
                calculatorState.activeStep = 'finish';
                calculatorState.winnerTeam = s1 >= 2500 ? 1 : 2;
                
                calculatorState.penalties = []; 
                
                const losingTeamId = s1 >= 2500 ? 2 : 1;
                const losingTeamScore = s1 >= 2500 ? s2 : s1;
                const losingMembers = calculatorState[`team${losingTeamId}`];

                losingMembers.forEach(uid => {
                    calculatorState.penalties.push({ playerId: uid, amount: 2, reason: 'Verloren (Spiel)' });
                });

                if(losingTeamScore < 1500) {
                    losingMembers.forEach(uid => {
                        calculatorState.penalties.push({ playerId: uid, amount: 1, reason: 'Berg (Schneider)' });
                    });
                }

                calculatorState.rounds.forEach(r => {
                    if (r.pA === 0) { 
                         calculatorState.team1.forEach(uid => calculatorState.penalties.push({ playerId: uid, amount: 1, reason: 'Match kassiert' }));
                    }
                    if (r.pB === 0) { 
                         calculatorState.team2.forEach(uid => calculatorState.penalties.push({ playerId: uid, amount: 1, reason: 'Match kassiert' }));
                    }
                });
            }
        };

        window.saveCalculatedGame = async () => {
            const batch = writeBatch(db);
            
            calculatorState.penalties.forEach(p => {
                const ref = doc(collection(db, COLLECTIONS.GAMES));
                batch.set(ref, {
                    playerId: p.playerId, 
                    points: p.amount, 
                    reason: p.reason, 
                    timestamp: serverTimestamp(), 
                    type: 'game-penalty', 
                    season: currentSeasonId, 
                    paid: false
                });
            });

            const winners = calculatorState[`team${calculatorState.winnerTeam}`];
            winners.forEach(uid => {
                 const ref = doc(collection(db, COLLECTIONS.GAMES));
                 batch.set(ref, {
                     playerId: uid, points: 1, type: 'game-win', timestamp: serverTimestamp(), season: currentSeasonId
                 });
            });

            await batch.commit();
            
            calculatorState = { team1: [], team2: [], rounds: [], penalties: [], activeStep: 'setup', selectedTrump: 'eichel' };
            setActiveTab('leaderboard');
        };
        
        window.payDebt = async (uid) => {
            if(!confirm("Schulden als BEZAHLT markieren?")) return;
            const unpaid = games.filter(g => g.playerId === uid && g.type === 'game-penalty' && !g.paid);
            const batch = writeBatch(db);
            unpaid.forEach(g => batch.update(doc(db, COLLECTIONS.GAMES, g.id), { paid: true, paidDate: serverTimestamp() }));
            await batch.commit();
        };
        window.abortGame = () => { if(confirm("Abbrechen?")) { calculatorState.activeStep='setup'; calculatorState.team1=[]; calculatorState.team2=[]; setActiveTab('leaderboard'); }};
        
        window.handleDeleteGame = async (id) => { if(!confirm("LÃ¶schen?")) return; if(prompt("Code") !== "JG2020") return; await deleteDoc(doc(db, COLLECTIONS.GAMES, id)); }; 
        window.handleDeleteEvent = async (id) => { if(!confirm("Event lÃ¶schen?")) return; await deleteDoc(doc(db, COLLECTIONS.EVENTS, id)); };

        const handleScroll = () => {
            const nav = document.getElementById('mobile-nav');
            if(nav) { if(window.scrollY > 50) nav.classList.add('translate-y-2', 'opacity-90', 'scale-95'); else nav.classList.remove('translate-y-2', 'opacity-90', 'scale-95'); }
        };

        // --- INIT ---
        const startApp = async () => {
            if(!firebaseConfig.apiKey || firebaseConfig.apiKey === '*') return document.getElementById('app').innerHTML = "<div class='p-10 text-center font-comic text-red-600'><h1>Error: Firebase Config fehlt!</h1></div>";
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onSnapshot(query(collection(db, COLLECTIONS.USERS)), sn => {
                users = sn.docs.map(d=>({id:d.id, ...d.data()}));
                if(user) userData = users.find(u => u.id === user.uid) || userData;
                if(userData?.role === 'admin') pendingUsers = users.filter(u => u.role === 'pending');
                renderApp();
            });
            onSnapshot(query(collection(db, COLLECTIONS.GAMES), orderBy('timestamp', 'desc')), sn => {
                games = sn.docs.map(d=>({id:d.id, ...d.data()}));
                renderApp();
            });
            onSnapshot(query(collection(db, COLLECTIONS.EVENTS), orderBy('date', 'asc')), sn => {
                events = sn.docs.map(d=>({id:d.id, ...d.data()}));
                renderApp();
            });
            onSnapshot(doc(db, COLLECTIONS.SETTINGS, 'config'), sn => {
                if(sn.exists()) currentSeasonId = sn.data().currentSeason || '2025';
                renderApp();
            });

            onAuthStateChanged(auth, async (u) => {
                user = u;
                if (user && !user.isAnonymous) {
                    const userRef = doc(db, COLLECTIONS.USERS, user.uid);
                    const snap = await getDoc(userRef);
                    if (!snap.exists()) {
                        userData = null; 
                        renderApp();
                    } else {
                        userData = snap.data();
                        if (user.email && ADMIN_EMAILS.includes(user.email) && userData.role !== 'admin') {
                            await updateDoc(userRef, { role: 'admin' });
                        }
                        renderApp();
                    }
                } else {
                    userData = null;
                    renderApp();
                }
                
                // DEEP LINK CHECK
                const urlParams = new URLSearchParams(window.location.search);
                const eid = urlParams.get('eid');
                if(eid && user) {
                    // Warte kurz bis Events geladen sind
                    setTimeout(() => window.openEventDetails(eid), 1500);
                }
            });
        };
        startApp();
    </script>
</body>
</html>