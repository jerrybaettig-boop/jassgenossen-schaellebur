<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jassgenossen Sch√§llebur</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3, .font-serif {
            font-family: 'Playfair Display', serif;
        }

        .font-hand {
            font-family: 'Kalam', cursive;
        }

        .loading-spinner { border-top-color: transparent; }

        /* BASE64 SCH√ÑLLE HINTERGRUND */
        .schalle-bg-pattern {
            background-color: #1a1a1a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M30 30c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10-10-4.477-10-10zm-5 5c0 2.76-2.24 5-5 5s-5-2.24-5-5 2.24-5 5-5 5 2.24 5 5zm0-10c0 2.76-2.24 5-5 5s-5-2.24-5-5 2.24-5 5-5 5 2.24 5 5zm10 25c0 2.76-2.24 5-5 5s-5-2.24-5-5 2.24-5 5-5 5 2.24 5 5zm-10 0c0 2.76-2.24 5-5 5s-5-2.24-5-5 2.24-5 5-5 5 2.24 5 5zM30 0c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10-10-4.477-10-10zM5 0c0 2.76-2.24 5-5 5S-5 2.76-5 0s2.24-5 5-5 5 2.24 5 5z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        /* Chalkboard Effect for Jass Tafel */
        .chalkboard {
            background-color: #2c3e50;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23ffffff' fill-opacity='0.05' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'/%3E%3C/svg%3E");
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            border: 8px solid #5d4037; /* Wood frame */
            border-radius: 4px;
        }
        
        .chalk-text {
            color: rgba(255,255,255,0.9);
            font-family: 'Kalam', cursive;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .chalk-line {
            stroke: rgba(255,255,255,0.8);
            stroke-width: 2;
            stroke-linecap: round;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }

        /* Mobile Navigation Fade Effect */
        .nav-scrolled {
            opacity: 0.6;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
        }
        .nav-scrolled:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="pb-24 md:pb-0"> 

    <div id="app"></div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // FIREBASE KONFIGURATION
        // ------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAPkAhM-BhJfG5cljBk2S2KGN3TIg8IxXM",
        authDomain: "jassgenossenschaellebur.firebaseapp.com",
        projectId: "jassgenossenschaellebur",
        storageBucket: "jassgenossenschaellebur.firebasestorage.app",
        messagingSenderId: "409989986638",
        appId: "1:409989986638:web:b1f4cd88b0521c92dac61f",
        measurementId: "G-BBFM2BD01V"
};

        // --- Constants ---
        const COLLECTION_NAME = 'jass_games';
        const ACCESS_CODE = 'JG2020'; 

        // Logo als SVG Base64 Fallback (Falls externes Bild nicht l√§dt)
        const LOGO_URL = "https://github.com/user-attachments/assets/aebb9a7b-aa92-4643-be2b-8dd06c255eea"; 
        
        // Players Data
        const initialPlayers = [
            { id: 'diego', name: 'Diego', score: 311, color: 'bg-red-500' },
            { id: 'toni', name: 'Toni', score: 208, color: 'bg-blue-500' },
            { id: 'laurent', name: 'Laurent', score: 218, color: 'bg-green-500' },
            { id: 'jerome', name: 'J√©r√¥me', score: 199, color: 'bg-amber-500' },
        ];

        // --- State ---
        let app, auth, db;
        let isConfigured = false;
        let user = null;
        let games = [];
        let activeTab = 'leaderboard';
        let leaderboard = [];

        // Calculator State
        let calculatorState = {
            team1: [],
            team2: [],
            rounds: [],
            penalties: [],
            activeStep: 'setup', 
            bergReached: false,
            startTime: null
        };
        
        let bulkEntryState = {}; 
        let currentMultiplier = 1;

        // --- UI Utils ---
        const renderLoading = () => `
            <div class="min-h-screen bg-slate-50 flex items-center justify-center flex-col gap-4">
                <div class="animate-spin w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full"></div>
                <div class="text-slate-400 text-sm font-medium animate-pulse">Lade Sch√§llebur...</div>
            </div>
        `;

        const renderErrorState = (msg) => `<div class="p-8 text-center text-red-600">${msg}</div>`;

        // HEADER
        const renderHeader = () => `
            <header class="schalle-bg-pattern bg-slate-900 text-white pt-10 pb-20 px-4 shadow-xl relative overflow-hidden">
                <div class="absolute inset-0 bg-black/50"></div>
                <div class="max-w-md mx-auto text-center relative z-10">
                    <div class="w-24 h-24 mx-auto mb-4 bg-white/10 backdrop-blur rounded-full flex items-center justify-center shadow-2xl border border-yellow-500/30">
                        <img src="${LOGO_URL}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmFjYzE1IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTYgOWgzbDItNmwzIDZoNGwxLTVsNCA1aDMiLz48cGF0aCBkPSJtMiAxNSAxMCAxMCAxMC0xMCIvPjwvc3ZnPg=='" 
                             class="w-16 h-16 object-contain filter drop-shadow-md transform hover:scale-110 transition-transform">
                    </div>
                    <h1 class="text-3xl font-bold tracking-tight mb-1 text-white text-shadow-lg font-serif">Jassgenossen</h1>
                    <h2 class="text-sm text-yellow-400 font-medium tracking-[0.2em] uppercase text-shadow-sm font-serif">Sch√§llebur</h2>
                </div>
            </header>
        `;

        // --- LEADERBOARD ---
        const renderLeaderboard = () => `
            <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="flex items-center justify-between px-2">
                    <h3 class="text-lg font-bold text-slate-700 font-serif">Rangliste</h3>
                    <span class="text-xs font-mono text-slate-400 bg-slate-100 px-2 py-1 rounded">Saison 24/25</span>
                </div>
                <ul class="grid gap-3">
                    ${leaderboard.map((player) => {
                        const isLeader = player.rank === 1;
                        return `
                            <li class="relative overflow-hidden rounded-xl bg-white border ${isLeader ? 'border-yellow-400 shadow-yellow-100' : 'border-slate-100'} shadow-sm p-4 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold text-sm ${isLeader ? 'bg-yellow-500 text-white' : 'bg-slate-100 text-slate-500'}">
                                        ${isLeader ? '<i data-lucide="crown" class="w-5 h-5"></i>' : '#' + player.rank}
                                    </div>
                                    <div>
                                        <div class="font-bold text-lg text-slate-800">${player.name}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-black ${isLeader ? 'text-yellow-600' : 'text-slate-700'}">${player.score}</div>
                                    <div class="text-[9px] text-slate-400 uppercase font-bold">CHF</div>
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
                <!-- Rules Card -->
                <div class="bg-slate-800 rounded-xl p-5 text-slate-300 text-sm shadow-lg mt-6 relative overflow-hidden">
                    <div class="absolute -right-6 -bottom-6 text-slate-700 opacity-20 transform rotate-12">
                        <i data-lucide="gavel" class="w-32 h-32"></i>
                    </div>
                    <h4 class="text-yellow-500 font-bold mb-3 flex items-center gap-2 font-serif"><i data-lucide="info" class="w-4 h-4"></i> Strafen</h4>
                    <ul class="space-y-2 relative z-10">
                        <li class="flex justify-between border-b border-slate-700/50 pb-1"><span>Match kassiert (0 Punkte)</span> <span class="text-white font-mono">+1.00</span></li>
                        <li class="flex justify-between border-b border-slate-700/50 pb-1"><span>Zuletzt √ºber Berg (1500)</span> <span class="text-white font-mono">+1.00</span></li>
                        <li class="flex justify-between"><span>Spiel verloren (2500)</span> <span class="text-white font-mono">+2.00</span></li>
                    </ul>
                </div>
            </div>
        `;

        // --- BULK ENTRY ---
        const renderBulkEntry = () => {
            if (Object.keys(bulkEntryState).length === 0) initialPlayers.forEach(p => bulkEntryState[p.id] = 0);
            return `
            <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden animate-in zoom-in-95 duration-300">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-100"><h2 class="text-lg font-bold text-slate-800">Direkteingabe</h2></div>
                <div class="p-6 space-y-4">
                    <div id="bulk-message-box" class="hidden p-3 rounded-lg text-sm text-center"></div>
                    ${initialPlayers.map(p => `
                        <div class="flex items-center justify-between p-2 rounded-xl border border-slate-100 hover:border-slate-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${p.color} text-white flex items-center justify-center font-bold text-xs">${p.name[0]}</div>
                                <span class="font-bold text-slate-700">${p.name}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="updateBulkScore('${p.id}', -1)" class="w-8 h-8 rounded-full border border-slate-200 text-slate-400 hover:bg-slate-50"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></button>
                                <input type="text" id="bulk-${p.id}" value="${bulkEntryState[p.id]}" readonly class="w-8 text-center font-bold text-lg bg-transparent border-none">
                                <button onclick="updateBulkScore('${p.id}', 1)" class="w-8 h-8 rounded-full bg-yellow-50 border border-yellow-200 text-yellow-600"><i data-lucide="plus" class="w-4 h-4 mx-auto"></i></button>
                            </div>
                        </div>
                    `).join('')}
                    <div class="pt-4 mt-2 border-t border-slate-100">
                        <input type="password" id="bulk-code" placeholder="Code eingeben" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 mb-3 text-center focus:ring-2 focus:ring-yellow-500 outline-none">
                        <button onclick="submitBulkEntry()" id="bulk-submit-btn" class="w-full bg-slate-900 text-white font-bold rounded-xl py-3 shadow-lg active:scale-95 transition-all">Speichern</button>
                    </div>
                </div>
            </div>`;
        };

        // --- JASS CALCULATOR (TAFEL) ---
        
        // Z-Board Drawer
        const getZPath = () => "M10,10 L90,10 L10,90 L90,90"; // Simple Z shape SVG path
        
        const renderVisualZBoard = (points) => {
            // Logic to visualize typical Swiss Jass writing
            // Hundreds: Top line ticks (V, X style)
            // Fifties: X on the cross
            // Twenties: Bottom line ticks
            // Singles: Number
            
            const hundreds = Math.floor(points / 100);
            const remainder100 = points % 100;
            const fifties = Math.floor(remainder100 / 50);
            const remainder50 = remainder100 % 50;
            const twenties = Math.floor(remainder50 / 20);
            const singles = remainder50 % 20;

            // Generate Chalk Marks SVG
            let marks = '';
            
            // Hundreds (Top Line)
            for(let i=0; i<hundreds; i++) {
                let x = 15 + (i*10);
                if (i===4 || i===9) { // Strike through for 5/10 usually, simplified here just slashes
                     marks += `<line x1="${x-5}" y1="5" x2="${x+5}" y2="15" class="chalk-line" />`; // simplified
                } else {
                     marks += `<line x1="${x}" y1="5" x2="${x}" y2="15" class="chalk-line" />`;
                }
            }

            // Fifties (Middle X)
            if (fifties > 0) {
                marks += `<line x1="40" y1="40" x2="60" y2="60" class="chalk-line" />`;
                marks += `<line x1="60" y1="40" x2="40" y2="60" class="chalk-line" />`;
            }

            // Twenties (Bottom Line)
            for(let i=0; i<twenties; i++) {
                let x = 15 + (i*10);
                marks += `<line x1="${x}" y1="85" x2="${x}" y2="95" class="chalk-line" />`;
            }

            return `
                <div class="relative w-full h-32 chalkboard p-2 flex flex-col justify-between">
                    <!-- SVG Overlay for Z and Marks -->
                    <svg viewBox="0 0 100 100" class="absolute inset-0 w-full h-full pointer-events-none opacity-50" preserveAspectRatio="none">
                        <path d="M5,10 L95,10 L5,90 L95,90" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" stroke-dasharray="4 2"/>
                    </svg>
                    
                    <!-- Dynamic Marks -->
                    <svg viewBox="0 0 100 100" class="absolute inset-0 w-full h-full pointer-events-none" preserveAspectRatio="none">
                         ${marks}
                    </svg>

                    <!-- Numeric Display (Singles) -->
                    <div class="absolute bottom-2 right-4 chalk-text text-2xl">${singles > 0 ? singles : ''}</div>
                    
                    <!-- Total Overlay (Optional, for clarity) -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/10 text-4xl font-bold font-hand select-none">${points}</div>
                </div>
            `;
        };

        const renderCalculator = () => {
            if (calculatorState.activeStep === 'setup') return renderCalcSetup();
            if (calculatorState.activeStep === 'play') return renderCalcPlay();
            return renderCalcFinish();
        };

        const renderCalcSetup = () => `
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden animate-in zoom-in-95">
                <div class="bg-slate-900 text-white p-6 text-center">
                    <h2 class="text-xl font-serif font-bold">Neue Jass-Runde</h2>
                    <p class="text-slate-400 text-xs mt-1">Teams definieren</p>
                </div>
                <div class="p-6 space-y-6">
                    ${[1, 2].map(teamNum => `
                        <div class="space-y-2">
                            <label class="text-xs font-bold ${teamNum===1?'text-blue-600':'text-red-600'} uppercase tracking-wider">Team ${teamNum}</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${initialPlayers.map(p => `
                                    <button onclick="toggleTeamSelection('${p.id}', ${teamNum})" 
                                        class="p-3 rounded-xl border-2 transition-all font-medium text-sm
                                        ${calculatorState[`team${teamNum}`].includes(p.id) 
                                            ? (teamNum===1 ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-red-500 bg-red-50 text-red-700') 
                                            : calculatorState[teamNum===1?'team2':'team1'].includes(p.id) ? 'opacity-30 border-slate-100 cursor-not-allowed' : 'border-slate-100 text-slate-600'}">
                                        ${p.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="startCalculatorGame()" 
                        ${(calculatorState.team1.length !== 2 || calculatorState.team2.length !== 2) ? 'disabled' : ''}
                        class="w-full py-4 rounded-xl font-bold text-lg transition-all shadow-lg flex items-center justify-center gap-2
                        ${(calculatorState.team1.length !== 2 || calculatorState.team2.length !== 2) ? 'bg-slate-200 text-slate-400' : 'bg-yellow-500 text-slate-900 hover:bg-yellow-400'}">
                        Spiel starten
                    </button>
                </div>
            </div>`;

        const renderCalcPlay = () => {
            const totalA = calculatorState.rounds.reduce((sum, r) => sum + r.pointsA + (r.weisA || 0), 0);
            const totalB = calculatorState.rounds.reduce((sum, r) => sum + r.pointsB + (r.weisB || 0), 0);
            
            const nameT1 = calculatorState.team1.map(id => initialPlayers.find(p => p.id === id).name).join(' & ');
            const nameT2 = calculatorState.team2.map(id => initialPlayers.find(p => p.id === id).name).join(' & ');

            return `
            <div class="flex flex-col h-full animate-in fade-in duration-300">
                <!-- Visual Board (Chalkboard Z) -->
                <div class="grid grid-cols-2 gap-1 mb-2">
                    <div class="text-center">
                        <div class="text-xs font-bold text-blue-800 mb-1 truncate">${nameT1}</div>
                        ${renderVisualZBoard(totalA)}
                    </div>
                    <div class="text-center">
                        <div class="text-xs font-bold text-red-800 mb-1 truncate">${nameT2}</div>
                        ${renderVisualZBoard(totalB)}
                    </div>
                </div>

                <!-- Input Area -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-4 mb-4">
                    <!-- Multipliers -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                        <button onclick="setMultiplier(1)" class="py-2 px-1 rounded-lg border text-[10px] md:text-xs font-bold transition-all ${currentMultiplier === 1 ? 'bg-slate-800 text-white border-slate-800' : 'bg-slate-50 text-slate-600 border-slate-200'}">
                            üå∏ Rose / üå∞ Eichle (1x)
                        </button>
                        <button onclick="setMultiplier(2)" class="py-2 px-1 rounded-lg border text-[10px] md:text-xs font-bold transition-all ${currentMultiplier === 2 ? 'bg-slate-800 text-white border-slate-800' : 'bg-slate-50 text-slate-600 border-slate-200'}">
                            üîî Sch√§lle / üõ°Ô∏è Schilt√§ (2x)
                        </button>
                        <button onclick="setMultiplier(3)" class="py-2 px-1 rounded-lg border text-[10px] md:text-xs font-bold transition-all ${currentMultiplier === 3 ? 'bg-slate-800 text-white border-slate-800' : 'bg-slate-50 text-slate-600 border-slate-200'}">
                            ‚¨ÜÔ∏è Obenabe (3x)
                        </button>
                        <button onclick="setMultiplier(3)" class="py-2 px-1 rounded-lg border text-[10px] md:text-xs font-bold transition-all ${currentMultiplier === 3 ? 'bg-slate-800 text-white border-slate-800' : 'bg-slate-50 text-slate-600 border-slate-200'}">
                            ‚¨áÔ∏è Uneufe (3x)
                        </button>
                    </div>

                    <!-- Points Inputs -->
                    <div class="grid grid-cols-[1fr,auto,1fr] gap-3 items-end mb-4">
                        <div>
                            <label class="text-[10px] font-bold text-blue-600 uppercase block mb-1 truncate">${nameT1}</label>
                            <input type="number" id="input-points-a" inputmode="numeric" oninput="calculatePoints('a')" placeholder="Punkte" 
                                class="w-full h-12 text-center text-xl font-bold border-b-2 border-blue-200 focus:border-blue-500 outline-none bg-slate-50 rounded-t-lg">
                        </div>
                        <div class="text-slate-300 font-light pb-3">vs</div>
                        <div>
                            <label class="text-[10px] font-bold text-red-600 uppercase block mb-1 truncate">${nameT2}</label>
                            <input type="number" id="input-points-b" inputmode="numeric" oninput="calculatePoints('b')" placeholder="Punkte" 
                                class="w-full h-12 text-center text-xl font-bold border-b-2 border-red-200 focus:border-red-500 outline-none bg-slate-50 rounded-t-lg">
                        </div>
                    </div>
                    
                    <!-- Weis Inputs -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                         <div>
                            <input type="number" id="input-weis-a" inputmode="numeric" placeholder="Weis" class="w-full text-center text-xs border border-slate-200 rounded-lg py-2">
                        </div>
                         <div>
                            <input type="number" id="input-weis-b" inputmode="numeric" placeholder="Weis" class="w-full text-center text-xs border border-slate-200 rounded-lg py-2">
                        </div>
                    </div>

                    <button onclick="submitRound()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">
                        Runde schreiben
                    </button>
                </div>
                
                <button onclick="abortGame()" class="mt-4 text-xs text-red-400 text-center w-full hover:underline">Spiel abbrechen</button>
            </div>`;
        };

        const renderCalcFinish = () => {
             const totalA = calculatorState.rounds.reduce((sum, r) => sum + r.pointsA + (r.weisA || 0), 0);
             const totalB = calculatorState.rounds.reduce((sum, r) => sum + r.pointsB + (r.weisB || 0), 0);
             const winnerTeam = totalA >= 2500 ? 1 : 2;
             
             return `
             <div class="bg-white rounded-2xl shadow-xl overflow-hidden text-center p-8 animate-in zoom-in-95">
                <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600 animate-bounce">
                    <i data-lucide="trophy" class="w-10 h-10"></i>
                </div>
                <h2 class="text-2xl font-serif font-bold text-slate-800 mb-2">Spiel beendet!</h2>
                <div class="text-4xl font-black text-slate-800 mb-4 font-mono">${Math.max(totalA, totalB)} <span class="text-lg text-slate-400">Punkte</span></div>
                
                <div class="bg-red-50 border border-red-100 rounded-xl p-4 mb-6 text-left">
                    <h3 class="font-bold text-red-800 text-sm uppercase tracking-wide mb-2 flex items-center gap-2"><i data-lucide="alert-octagon" class="w-4 h-4"></i> Zu vergebende Strafen</h3>
                    ${calculatorState.penalties.length > 0 ? `
                        <ul class="space-y-2">
                            ${calculatorState.penalties.map(p => `
                                <li class="flex justify-between items-center text-sm border-b border-red-100 last:border-0 pb-1 last:pb-0">
                                    <span class="text-slate-700 font-medium">${initialPlayers.find(pl => pl.id === p.playerId).name}</span>
                                    <div class="text-right"><div class="font-bold text-red-600">+${p.amount} CHF</div><div class="text-[10px] text-red-400">${p.reason}</div></div>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<div class="text-sm text-slate-400 italic">Keine Strafen.</div>'}
                </div>

                <div class="space-y-3">
                    <input type="password" id="finish-code" placeholder="Code eingeben" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-center font-mono focus:ring-2 focus:ring-slate-800 outline-none">
                    <button onclick="saveCalculatedGame()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg transition-all">Spiel & Strafen speichern</button>
                </div>
             </div>`;
        };

        // --- HISTORY (GROUPED) ---
        const renderHistory = () => {
            // Group games by "gameId" or close timestamps (within 1 min)
            // Simplified: We assume bulk entries or calculator entries share a timestamp usually, or close enough.
            // Better: Group by `recordedBy` + `timestamp` minute.
            
            // Let's visualize simply as a list first, but richer.
            return `
            <div class="space-y-4 animate-in fade-in duration-500">
                 <div class="flex items-center justify-between px-2">
                    <h3 class="text-lg font-bold text-slate-700 font-serif">Verlauf</h3>
                </div>
                ${games.length === 0 ? '<div class="text-center py-12 text-slate-400">Keine Eintr√§ge.</div>' : 
                games.map(game => {
                    const player = initialPlayers.find(p => p.id === game.playerId);
                    const date = game.timestamp?.toDate ? game.timestamp.toDate() : new Date();
                    const dateStr = date.toLocaleDateString('de-CH');
                    const timeStr = date.toLocaleTimeString('de-CH', {hour: '2-digit', minute:'2-digit'});
                    
                    return `
                        <div class="bg-white rounded-xl p-3 border border-slate-100 shadow-sm flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-12 ${player?.color} rounded-full"></div>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm">${player?.name}</div>
                                    <div class="text-[10px] text-slate-400">${game.reason || (game.type==='direct' ? 'Direkteingabe' : 'Spielstrafe')}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-red-600 text-lg">+${game.points}</span>
                                <div class="text-[10px] text-slate-400">${dateStr} ${timeStr}</div>
                                <button onclick="handleDeleteGame('${game.id}')" class="text-[10px] text-red-300 hover:text-red-500 underline mt-1">L√∂schen</button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>`;
        };

        const renderMobileNav = () => `
            <nav id="mobile-nav" class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 px-6 py-2 flex justify-between items-end z-50 md:hidden pb-safe">
                ${['leaderboard', 'calculator', 'add', 'history'].map(tab => {
                    const isActive = activeTab === tab;
                    const icons = { leaderboard: 'trophy', calculator: 'calculator', add: 'list-plus', history: 'history' };
                    const labels = { leaderboard: 'Rangliste', calculator: 'Tafel', add: 'Eintrag', history: 'Verlauf' };
                    return `<button onclick="setActiveTab('${tab}')" class="flex flex-col items-center gap-1 w-16 py-2 transition-all ${isActive ? 'text-yellow-600' : 'text-slate-400'}">
                            <i data-lucide="${icons[tab]}" class="w-6 h-6 ${isActive ? 'fill-current opacity-20 stroke-[2.5]' : ''}"></i>
                            <span class="text-[10px] font-medium tracking-tight">${labels[tab]}</span>
                        </button>`;
                }).join('')}
            </nav>
            <style>.pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }</style>
        `;

        const renderApp = () => {
            const tabs = { leaderboard: renderLeaderboard, add: renderBulkEntry, calculator: renderCalculator, history: renderHistory };
            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                <main class="max-w-xl mx-auto px-4 -mt-6 relative z-10 pb-20">
                     <div class="hidden md:flex justify-center gap-4 -mt-8 relative z-20 mb-8 px-4">
                        ${Object.keys(tabs).map(t => `<button onclick="setActiveTab('${t}')" class="px-6 py-2 rounded-xl font-bold shadow-sm transition-all ${activeTab===t?'bg-yellow-500 text-slate-900':'bg-white text-slate-600'}">${t.toUpperCase()}</button>`).join('')}
                    </div>
                    ${tabs[activeTab]()}
                </main>
                ${renderMobileNav()}
            `;
            lucide.createIcons();
            window.removeEventListener('scroll', handleScroll);
            window.addEventListener('scroll', handleScroll);
        };

        // --- CONTROLLER ---
        
        window.updateBulkScore = (pid, chg) => {
            bulkEntryState[pid] = Math.max(0, (bulkEntryState[pid]||0) + chg);
            renderApp();
        };

        window.submitBulkEntry = async () => {
            const code = document.getElementById('bulk-code').value;
            if (code !== ACCESS_CODE) return alert("Falscher Code!");
            
            const entries = Object.entries(bulkEntryState).filter(([_, v]) => v > 0);
            if (entries.length === 0) return alert("Keine Punkte vergeben.");
            
            document.getElementById('bulk-submit-btn').textContent = "Speichere...";
            const batch = writeBatch(db);
            entries.forEach(([pid, pts]) => {
                batch.set(doc(collection(db, COLLECTION_NAME)), {
                    playerId: pid, points: pts, timestamp: serverTimestamp(),
                    recordedBy: user ? user.uid : 'bulk', type: 'direct'
                });
            });
            await batch.commit();
            bulkEntryState = {};
            setActiveTab('leaderboard');
        };

        // Calculator Logic
        window.toggleTeamSelection = (pid, team) => {
            const other = team === 1 ? 2 : 1;
            const myArr = calculatorState[`team${team}`];
            const otherArr = calculatorState[`team${other}`];
            
            if (myArr.includes(pid)) calculatorState[`team${team}`] = myArr.filter(id => id !== pid);
            else if (!otherArr.includes(pid) && myArr.length < 2) calculatorState[`team${team}`].push(pid);
            renderApp();
        };

        window.startCalculatorGame = () => {
            calculatorState.activeStep = 'play';
            calculatorState.rounds = [];
            calculatorState.penalties = [];
            calculatorState.bergReached = false;
            renderApp();
        };

        window.setMultiplier = (m) => {
            currentMultiplier = m;
            renderApp();
        };

        window.calculatePoints = (src) => {
            const inA = document.getElementById('input-points-a');
            const inB = document.getElementById('input-points-b');
            let val = parseInt(src==='a'?inA.value:inB.value) || 0;
            
            // Max Points Logic
            // If user enters > 157, it's invalid unless handled differently. 
            // For UI simplicity, we clamp visually for calculation but keep logic for Match (157 input = 257 total)
            if (val > 157) val = 157; 

            if (src==='a') inB.value = 157 - val;
            else inA.value = 157 - val;
        };

        window.submitRound = () => {
            const pA_in = parseInt(document.getElementById('input-points-a').value) || 0;
            const pB_in = parseInt(document.getElementById('input-points-b').value) || 0;
            const wA = parseInt(document.getElementById('input-weis-a').value) || 0;
            const wB = parseInt(document.getElementById('input-weis-b').value) || 0;

            if (pA_in + pB_in !== 157) return alert("Summe muss 157 sein!");

            // MATCH LOGIC: If input is 157, actual points are 257
            let realPA = pA_in === 157 ? 257 : pA_in;
            let realPB = pB_in === 157 ? 257 : pB_in;

            // Apply Multiplier
            const pointsA = (realPA * currentMultiplier) + (wA * currentMultiplier);
            const pointsB = (realPB * currentMultiplier) + (wB * currentMultiplier);

            // Penalties
            if (pA_in === 157) addPenalty(calculatorState.team2, 1, "Match kassiert (zu 0)");
            if (pB_in === 157) addPenalty(calculatorState.team1, 1, "Match kassiert (zu 0)");

            calculatorState.rounds.push({ pointsA, pointsB, weisA: wA*currentMultiplier, weisB: wB*currentMultiplier, multiplier: currentMultiplier });
            
            checkBerg();

            // Check Game End
            const sumA = calculatorState.rounds.reduce((s,r)=>s+r.pointsA,0);
            const sumB = calculatorState.rounds.reduce((s,r)=>s+r.pointsB,0);
            
            if (sumA >= 2500 || sumB >= 2500) {
                const loser = sumA > sumB ? calculatorState.team2 : calculatorState.team1;
                addPenalty(loser, 2, "Spiel verloren");
                calculatorState.activeStep = 'finish';
            } else {
                currentMultiplier = 1; // Reset multiplier only, keeping game active
            }
            renderApp();
            
            if(calculatorState.activeStep === 'play') {
                 setTimeout(() => {
                    const el = document.getElementById('input-points-a');
                    if(el) { el.value=''; document.getElementById('input-points-b').value='157'; el.focus(); }
                    document.getElementById('input-weis-a').value=''; document.getElementById('input-weis-b').value='';
                 }, 50);
            }
        };

        const addPenalty = (team, amt, rsn) => team.forEach(pid => calculatorState.penalties.push({ playerId: pid, amount: amt, reason: rsn }));

        const checkBerg = () => {
            if (calculatorState.bergReached) return;
            const sumA = calculatorState.rounds.reduce((s,r)=>s+r.pointsA,0);
            const sumB = calculatorState.rounds.reduce((s,r)=>s+r.pointsB,0);
            if (sumA >= 1500 && sumB < 1500) { addPenalty(calculatorState.team2, 1, "Gegner √ºber Berg"); calculatorState.bergReached=true; }
            else if (sumB >= 1500 && sumA < 1500) { addPenalty(calculatorState.team1, 1, "Gegner √ºber Berg"); calculatorState.bergReached=true; }
        };

        window.saveCalculatedGame = async () => {
            const code = document.getElementById('finish-code').value;
            if (code !== ACCESS_CODE) return alert("Falscher Code!");
            
            const batch = writeBatch(db);
            calculatorState.penalties.forEach(p => {
                batch.set(doc(collection(db, COLLECTION_NAME)), {
                    playerId: p.playerId, points: p.amount, reason: p.reason,
                    timestamp: serverTimestamp(), type: 'game-penalty'
                });
            });
            await batch.commit();
            calculatorState = { team1: [], team2: [], rounds: [], penalties: [], activeStep: 'setup', bergReached: false };
            setActiveTab('leaderboard');
        };

        window.abortGame = () => {
            if(confirm("Abbrechen?")) {
                calculatorState = { team1: [], team2: [], rounds: [], penalties: [], activeStep: 'setup', bergReached: false };
                setActiveTab('leaderboard');
            }
        };

        window.handleDeleteGame = async (id) => {
            if(!confirm("L√∂schen?")) return;
            const code = prompt("Code:");
            if(code !== ACCESS_CODE) return alert("Falsch");
            await deleteDoc(doc(db, COLLECTION_NAME, id));
        };

        window.setActiveTab = (t) => { activeTab = t; renderApp(); window.scrollTo(0,0); };
        const handleScroll = () => {
            const nav = document.getElementById('mobile-nav');
            if(nav) window.scrollY > 50 ? nav.classList.add('nav-scrolled') : nav.classList.remove('nav-scrolled');
        };

        // --- INIT ---
        const startApp = async () => {
            if(!firebaseConfig.apiKey || firebaseConfig.apiKey === '*') return document.getElementById('app').innerHTML = renderErrorState("Firebase Config fehlt in index.html");
            document.getElementById('app').innerHTML = renderLoading();
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                user = auth.currentUser;
                onSnapshot(query(collection(db, COLLECTION_NAME)), sn => {
                    games = sn.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
                    const totals = {}; initialPlayers.forEach(p=>totals[p.id]=p.score);
                    games.forEach(g => { if(totals[g.playerId]!==undefined) totals[g.playerId]+=g.points; });
                    leaderboard = initialPlayers.map(p=>({...p, score: totals[p.id]})).sort((a,b)=>a.score-b.score);
                    leaderboard.forEach((p,i)=>p.rank=i+1);
                    renderApp();
                });
            } catch(e) { document.getElementById('app').innerHTML = renderErrorState(e.message); }
        };
        startApp();
    </script>
</body>
</html>