<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jassgenossen Schällebur - Leaderboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .loading-spinner { border-top-color: transparent; }
        /* Style for the logo placeholder if the image fails */
        #logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- The entire application will be rendered here -->
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ------------------------------------------------------------------
        // ##################################################################
        // SCHRITT 1: FÜGEN SIE IHRE FIREBASE KONFIGURATION HIER EIN!
        // ------------------------------------------------------------------
        
    const firebaseConfig = {
        apiKey: "AIzaSyAPkAhM-BhJfG5cljBk2S2KGN3TIg8IxXM",
        authDomain: "jassgenossenschaellebur.firebaseapp.com",
        projectId: "jassgenossenschaellebur",
        storageBucket: "jassgenossenschaellebur.firebasestorage.app",
        messagingSenderId: "409989986638",
        appId: "1:409989986638:web:b1f4cd88b0521c92dac61f",
        measurementId: "G-BBFM2BD01V"
};

        // --- Constants ---
        const MEMBERS = ['Laurent', 'Toni', 'Diego', 'Jérôme'];
        const COLLECTION_NAME = 'jass_games';
        const LOGO_URL = "https://i.imgur.com/K073w5L.png"; // Ihr Club-Logo
        const ACCESS_CODE = '1993'; // <-- Zugangscode für Punkteingabe
        // Define primary gold and black colors for consistency
        const PRIMARY_GOLD = 'bg-yellow-500';
        const PRIMARY_GOLD_HOVER = 'hover:bg-yellow-600';
        const PRIMARY_BLACK_TEXT = 'text-gray-900';
        const PRIMARY_BLACK_HEADER = 'bg-gradient-to-br from-gray-900 to-gray-700';


        // --- Utility Functions ---
        
        const renderErrorState = (message, details = "") => `
            <div class="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-8 text-center">
                <i data-lucide="alert-triangle" class="text-red-500 w-12 h-12 mb-4"></i>
                <h1 class="text-2xl font-bold text-red-700 mb-2">Website Fehler</h1>
                <p class="text-slate-600 max-w-md">${message}</p>
                ${details ? `<p class="text-sm text-slate-500 mt-3 p-3 bg-red-100 rounded-lg">${details}</p>` : ''}
                <p class="text-xs text-slate-400 mt-4">Prüfen Sie Ihre 'index.html' und die Firebase Konsole.</p>
            </div>
        `;


        // --- Firebase Initialization ---
        let app, auth, db;
        let isConfigured = false;
        
        // CHECK if any key is provided
        if (!firebaseConfig.apiKey) {
            document.getElementById('app').innerHTML = renderErrorState(
                "Fehler: Firebase Konfiguration fehlt.",
                "Bitte fügen Sie Ihre Firebase Schlüssel in die 'firebaseConfig'-Variable in der 'index.html' ein."
            );
        } else {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isConfigured = true;
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('app').innerHTML = renderErrorState("Fehler beim Initialisieren von Firebase.", e.message);
            }
        }
        
        let user = null;
        let games = [];
        let activeTab = 'leaderboard';
        let leaderboard = [];
        
        // --- Utility Functions (continued) ---

        /** Renders a common card component */
        const renderCard = (content, className = "") => `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}">
                ${content}
            </div>
        `;
        
        const renderLoading = () => `
            <div class="min-h-screen bg-slate-50 flex items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 ${PRIMARY_GOLD.replace('bg-', 'border-')} loading-spinner"></div>
            </div>
        `;

        const renderHeader = () => `
            <header class="${PRIMARY_BLACK_HEADER} text-white pt-8 pb-16 px-4 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                   <i data-lucide="club" class="absolute -top-10 -left-10 w-48 h-48 rotate-12 text-gray-500"></i>
                   <i data-lucide="club" class="absolute bottom-0 right-0 w-32 h-32 -rotate-12 text-gray-500"></i>
                </div>
                <div class="max-w-md mx-auto text-center relative z-10">
                    <div id="logo-container" class="bg-white/10 w-24 h-24 rounded-2xl mx-auto mb-4 backdrop-blur-sm shadow-inner border border-white/20 overflow-hidden p-1">
                        <img 
                            src="${LOGO_URL}" 
                            alt="Club Logo" 
                            class="w-full h-full object-contain"
                            onerror="this.style.display='none'; document.getElementById('logo-placeholder').style.display='flex';"
                        />
                        <i id="logo-placeholder" data-lucide="club" class="text-white w-12 h-12" style="display:none;"></i>
                    </div>
                    <h1 class="text-2xl font-bold tracking-tight mb-1">Jassgenossen Schällebur</h1>
                    <p class="text-gray-100 text-sm font-medium opacity-90">Est. 2020 • Zürich</p>
                </div>
            </header>
        `;

        const renderNavigation = () => `
            ${activeTab !== 'about' ? renderCard(`
                <div class="flex p-1 bg-slate-100 border-none">
                    <button onclick="setActiveTab('leaderboard')" class="flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'leaderboard' ? `${PRIMARY_GOLD.replace('bg-', 'bg-')} ${PRIMARY_BLACK_TEXT} shadow-sm` : 'text-slate-500'}">Rankings</button>
                    <button onclick="setActiveTab('add')" class="flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'add' ? `${PRIMARY_GOLD.replace('bg-', 'bg-')} ${PRIMARY_BLACK_TEXT} shadow-sm` : 'text-slate-500'}">Add Points</button>
                    <button onclick="setActiveTab('history')" class="flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'history' ? `${PRIMARY_GOLD.replace('bg-', 'bg-')} ${PRIMARY_BLACK_TEXT} shadow-sm` : 'text-slate-500'}">History</button>
                </div>
            `, "flex p-1 bg-slate-100 border-none") : ''}
        `;
        
        const getLeaderboard = (gameData) => {
            const totals = { Laurent: 209, Toni: 207, Diego: 310, Jérôme: 199 };
            const gamesPlayed = { Laurent: 100, Toni: 100, Diego: 100, Jérôme: 100 };

            gameData.forEach(game => {
                MEMBERS.forEach(member => {
                    if (game.scores && typeof game.scores[member] === 'number') {
                        totals[member] += game.scores[member];
                        gamesPlayed[member] += 1;
                    }
                });
            });

            return Object.entries(totals)
                .map(([name, score]) => ({ 
                    name, 
                    score, 
                    played: gamesPlayed[name] 
                }))
                .sort((a, b) => b.score - a.score);
        };

        const renderLeaderboard = () => `
            <div class="space-y-4">
                <div class="grid gap-3">
                    ${leaderboard.map((player, index) => `
                        <div class="relative overflow-hidden rounded-xl p-4 flex items-center justify-between transition-all ${index === 0 
                            ? 'bg-gradient-to-r from-amber-50 to-amber-100 border-amber-200 border shadow-sm' // Golden for 1st place
                            : 'bg-white border border-slate-200 shadow-sm'
                        }">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${index === 0 ? 'bg-amber-200 text-amber-800' : index === 1 ? 'bg-slate-100 text-slate-600' : index === 2 ? 'bg-orange-50 text-orange-700' : 'bg-slate-50 text-slate-400'}">
                                    ${index + 1}
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">${player.name}</h3>
                                    <p class="text-xs text-slate-500">${player.played} Games Played</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-black tracking-tight ${index === 0 ? 'text-amber-700' : 'text-slate-800'}">
                                    ${player.score.toLocaleString()}
                                </span>
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Points</p>
                            </div>
                            ${index === 0 ? '<i data-lucide="crown" class="absolute -top-1 -right-1 text-amber-200 rotate-12 w-12 h-12"></i>' : ''}
                        </div>
                    `).join('')}
                </div>
                
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mt-6">
                    <h4 class="text-blue-800 font-semibold text-sm mb-1 flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4"></i> Club Purpose
                    </h4>
                    <p class="text-blue-900/80 text-sm leading-relaxed">
                        We are Jassgenossen Schällebur. Dedicated to the art of Jass, cultivating friendship, honouring tradition, and always playing the perfect Trumpf.
                    </p>
                </div>
            </div>
        `;

        const renderAddScore = () => `
            ${renderCard(`
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="${PRIMARY_GOLD.replace('bg-', 'text-')} w-5 h-5"></i> New Game Entry
                </h2>
                <form id="addGameForm" class="space-y-4">
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                        <label for="accessCode" class="block text-xs font-semibold uppercase text-gray-500 mb-1">Access Code (Required)</label>
                        <input
                            type="password"
                            id="accessCode"
                            placeholder="Enter ${ACCESS_CODE}"
                            class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2 font-mono text-lg focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all"
                        />
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${MEMBERS.map(member => `
                            <div class="flex items-center gap-3">
                                <label for="score-${member}" class="w-24 font-medium text-slate-700">${member}</label>
                                <input
                                    type="number"
                                    id="score-${member}"
                                    name="${member}"
                                    placeholder="0"
                                    class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-lg font-semibold focus:outline-none focus:ring-2 ${PRIMARY_GOLD.replace('bg-', 'focus:ring-')} focus:border-transparent transition-all"
                                />
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" id="submitBtn" class="w-full text-lg px-4 py-3 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 ${PRIMARY_GOLD} ${PRIMARY_BLACK_TEXT} ${PRIMARY_GOLD_HOVER} shadow-xl shadow-yellow-800/20">
                            Save Points
                        </button>
                    </div>
                </form>
            `, "p-6")}
        `;

        const renderHistory = () => `
            <div class="space-y-4">
                <h2 class="font-bold text-slate-500 text-sm uppercase tracking-wider ml-1">Recent Games</h2>
                ${games.length === 0 ? `
                    <div class="text-center py-12 text-slate-400">
                        <i data-lucide="history" class="mx-auto mb-3 opacity-20 w-12 h-12"></i>
                        <p>No games recorded yet.</p>
                    </div>
                ` : games.map(game => `
                    ${renderCard(`
                        <div class="flex justify-between items-start mb-3 border-b border-slate-100 pb-2">
                            <div class="text-xs font-semibold text-slate-400 flex items-center gap-1">
                                <i data-lucide="layout-dashboard" class="w-3 h-3"></i>
                                ${game.timestamp?.toDate ? game.timestamp.toDate().toLocaleDateString() : 'Just now'}
                            </div>
                            <button 
                                onclick="handleDeleteGame('${game.id}')"
                                class="text-xs text-red-300 hover:text-red-600 px-2">
                                Delete
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-y-2 text-sm">
                            ${Object.entries(game.scores || {})
                                .sort(([,a], [,b]) => b - a)
                                .map(([name, score]) => `
                                    <div class="flex justify-between pr-4">
                                        <span class="text-slate-600">${name}</span>
                                        <span class="font-bold text-slate-900">${score}</span>
                                    </div>
                                `).join('')}
                        </div>
                    `, "p-4")}
                `).join('')}
            </div>
        `;

        const renderMobileNav = () => `
            <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-3 flex justify-around items-center z-50 md:hidden">
                <button onclick="setActiveTab('leaderboard')" class="flex flex-col items-center gap-1 ${activeTab === 'leaderboard' ? PRIMARY_BLACK_TEXT : 'text-slate-400'}">
                    <i data-lucide="trophy" class="w-5 h-5 ${activeTab === 'leaderboard' ? 'stroke-[2.5]' : ''}"></i>
                    <span class="text-[10px] font-medium">Rankings</span>
                </button>
                <button onclick="setActiveTab('add')" class="${PRIMARY_GOLD} ${PRIMARY_BLACK_TEXT} p-3 rounded-full shadow-lg shadow-yellow-800/30 -mt-6 border-4 border-slate-50">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i>
                </button>
                <button onclick="setActiveTab('history')" class="flex flex-col items-center gap-1 ${activeTab === 'history' ? PRIMARY_BLACK_TEXT : 'text-slate-400'}">
                    <i data-lucide="history" class="w-5 h-5 ${activeTab === 'history' ? 'stroke-[2.5]' : ''}"></i>
                    <span class="text-[10px] font-medium">History</span>
                </button>
            </nav>
        `;

        const renderApp = () => {
            let content = '';
            if (activeTab === 'leaderboard') {
                content = renderLeaderboard();
            } else if (activeTab === 'add') {
                content = renderAddScore();
            } else if (activeTab === 'history') {
                content = renderHistory();
            }

            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                <main class="max-w-md mx-auto px-4 -mt-8 relative z-10 space-y-6">
                    ${renderNavigation()}
                    ${content}
                </main>
                ${renderMobileNav()}
            `;
            // Re-render Lucide icons after DOM update
            lucide.createIcons();
            attachEventListeners();
        };

        // --- Controller Functions ---

        window.setActiveTab = (tab) => {
            activeTab = tab;
            renderApp();
        };
        
        window.handleDeleteGame = async (gameId) => {
            if(!confirm("Sind Sie sicher, dass Sie diesen Spieleintrag löschen möchten?")) return; 
            try {
                const fullPath = collection(db, COLLECTION_NAME); 
                await deleteDoc(doc(fullPath, gameId));
            } catch (error) {
                console.error("Error deleting:", error);
                alert("Der Spieleintrag konnte nicht gelöscht werden.");
            }
        };

        const attachEventListeners = () => {
            const form = document.getElementById('addGameForm');
            if (form) {
                form.onsubmit = handleAddGame;
            }
        };
        
        const handleAddGame = async (e) => {
            e.preventDefault();
            const accessCodeInput = document.getElementById('accessCode');

            // 1. Check Access Code
            if (accessCodeInput.value !== ACCESS_CODE) {
                alert("Falscher Zugangscode. Bitte versuchen Sie es erneut.");
                accessCodeInput.value = ''; // Clear the incorrect code
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Speichern...';
            submitBtn.disabled = true;

            try {
                const parsedScores = {};
                let hasData = false;
                
                MEMBERS.forEach(member => {
                    const input = document.getElementById(`score-${member}`);
                    const val = parseInt(input.value);
                    if (!isNaN(val) && val > 0) {
                        parsedScores[member] = val;
                        hasData = true;
                    } else {
                         parsedScores[member] = 0;
                    }
                });

                if (!hasData) {
                    alert("Bitte geben Sie mindestens einen Score grösser als 0 ein.");
                    return;
                }

                const fullPath = collection(db, COLLECTION_NAME); 
                await addDoc(fullPath, {
                    timestamp: serverTimestamp(),
                    createdBy: user ? user.uid : 'anonymous',
                    scores: parsedScores,
                    type: 'Standard Jass'
                });

                // Reset form and go to leaderboard
                MEMBERS.forEach(member => document.getElementById(`score-${member}`).value = '');
                accessCodeInput.value = ''; // Clear code after success
                setActiveTab('leaderboard');
            } catch (error) {
                console.error("Error adding game:", error);
                alert("Der Spielstand konnte nicht gespeichert werden. Bitte prüfen Sie Ihre Firebase Regeln.");
            } finally {
                submitBtn.textContent = 'Save Points';
                submitBtn.disabled = false;
            }
        };

        // ------------------------------------------------------------------
        // KORRIGIERTER STARTUP-BLOCK: Erzwingt die anonyme Anmeldung direkt.
        // ------------------------------------------------------------------
        async function startApp() {
            if (!isConfigured) return;

            document.getElementById('app').innerHTML = renderLoading();

            try {
                // ERZWINGT ANONYME ANMELDUNG
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;

                // Start listening for data ONLY after successful sign-in
                const gamesRef = collection(db, COLLECTION_NAME);
                const q = query(gamesRef);

                onSnapshot(q, (snapshot) => {
                    games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    games.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    leaderboard = getLeaderboard(games);
                    renderApp();
                }, (error) => {
                    console.error("Firestore error:", error);
                    document.getElementById('app').innerHTML = renderErrorState(
                        "Datenbankverbindung fehlgeschlagen.",
                        "Mögliche Ursachen: 1) Firebase-Schlüssel fehlen/falsch, 2) Firestore-Sicherheitsregeln erlauben keinen Zugriff, 3) Autorisierte Domain fehlt in Firebase Auth."
                    );
                });

            } catch (error) {
                console.error("Critical Auth Error:", error);
                document.getElementById('app').innerHTML = renderErrorState(
                    "Kritischer Anmeldefehler.",
                    `Der Browser/Server blockiert die Authentifizierung. Bitte prüfen Sie die **Autorisierten Domains** und aktivieren Sie **Anonyme Anmeldung** in Firebase Auth.`
                );
            }
        }

        startApp();
    </script>
</body>

</html>
